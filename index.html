<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GEPT Challenge âš¡ (æ•´åˆç‰ˆ)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --accent-cyan: #00e0ff;
      --accent-lime: #00ff9d;
      --accent-pink: #ff4b9f;
      --bg-deep: #050816;
      --card-bg: rgba(8, 16, 32, 0.9);
      --border-glow: rgba(0, 224, 255, 0.4);
      --text-main: #f5f7ff;
      --text-muted: #9ca3c4;
      --danger: #ff3860;
      --success: #00ff9d;
      --shadow-strong: 0 18px 40px rgba(0, 0, 0, 0.7);
      /* âœ… æ’è¡Œæ¦œé¡è‰² */
      --gold: #FFD700;
      --silver: #C0C0C0;
      --bronze: #CD7F32;
    }

    /* äº®è‰²ä¸»é¡Œåˆ‡æ› */
    body.light-mode {
      --accent-cyan: #38bdf8;
      --accent-lime: #22c55e;
      --bg-deep: #f8fafc;
      --card-bg: #ffffff;
      --border-glow: rgba(148, 163, 184, 0.4);
      --text-main: #1e293b;
      --text-muted: #64748b;
      --shadow-strong: 0 10px 20px rgba(148, 163, 184, 0.45);
      /* âœ… æ’è¡Œæ¦œé¡è‰² */
      --gold: #D4AF37;
      --silver: #8E8E8E;
      --bronze: #B87333;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Poppins", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      max-width: 960px;
      margin: 24px auto;
      padding: 16px;
      color: var(--text-main);
      background: radial-gradient(circle at top, #1b2845 0, #050816 55%, #000 100%);
      background-size: 200% 200%;
      animation: bgMove 26s ease-in-out infinite;
      position: relative;
      min-height: 100vh;
      overflow-x: hidden;
      transition: background 0.4s ease, color 0.4s ease;
    }

    /* èƒŒæ™¯å…‰çƒ */
    body::before,
    body::after {
      content: "";
      position: fixed;
      width: 320px;
      height: 320px;
      border-radius: 50%;
      pointer-events: none;
      z-index: -1;
      filter: blur(2px);
      opacity: 0.7;
    }

    body::before {
      top: -80px;
      left: -60px;
      background: radial-gradient(circle at center, rgba(0, 224, 255, 0.45), transparent 65%);
      animation: floatOrb 18s ease-in-out infinite;
    }

    body::after {
      bottom: -120px;
      right: -40px;
      background: radial-gradient(circle at center, rgba(255, 75, 159, 0.45), transparent 65%);
      animation: floatOrbReverse 22s ease-in-out infinite;
    }

    body.light-mode::before,
    body.light-mode::after {
      opacity: 0.35;
      filter: blur(1px);
    }

    @keyframes bgMove {
      0% { background-position: 0% 0%; }
      50% { background-position: 100% 60%; }
      100% { background-position: 0% 0%; }
    }

    @keyframes floatOrb {
      0% { transform: translate3d(0, 0, 0) scale(1); }
      50% { transform: translate3d(40px, 30px, 0) scale(1.1); }
      100% { transform: translate3d(-10px, -20px, 0) scale(1.02); }
    }

    @keyframes floatOrbReverse {
      0% { transform: translate3d(0, 0, 0) scale(1.05); }
      50% { transform: translate3d(-30px, -20px, 0) scale(1.15); }
      100% { transform: translate3d(20px, 25px, 0) scale(1.05); }
    }

    .game-card {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 24px 20px 32px;
      box-shadow: var(--shadow-strong);
      border: 1px solid var(--border-glow);
      backdrop-filter: blur(8px);
      position: relative;
    }

    h1 {
      text-align: center;
      color: var(--accent-cyan);
      font-size: 2.4em;
      margin-top: 4px;
      margin-bottom: 8px;
      text-shadow: 0 0 10px rgba(0, 224, 255, 0.9);
    }

    body.light-mode h1 {
      text-shadow: none;
    }

    .subtitle {
      text-align: center;
      font-size: 0.95em;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      align-items: center;
      margin-bottom: 8px;
    }

    .control-row label {
      font-size: 0.95em;
      color: var(--text-muted);
    }

    #dataset {
      padding: 8px 12px;
      font-size: 0.95em;
      border-radius: 999px;
      /* âœ… ç§»é™¤é‚Šæ¡†ï¼Œæ”¹ç”¨èƒŒæ™¯è‰²å€åˆ† */
      border: 1px solid transparent; 
      background: rgba(255, 255, 255, 0.05); /* ç»ç’ƒæ“¬æ…‹èƒŒæ™¯ */
      color: var(--text-main);
      min-width: 230px;
      outline: none;
      box-shadow: 0 0 0 0 rgba(0, 224, 255, 0.0);
      transition: box-shadow 0.2s ease, border-color 0.2s ease, transform 0.12s ease, background 0.2s ease;
    }

    body.light-mode #dataset {
      /* âœ… ç§»é™¤é‚Šæ¡†ï¼Œæ”¹ç”¨èƒŒæ™¯è‰²å€åˆ† (Light) */
      border: 1px solid transparent;
      background: rgba(0, 0, 0, 0.03);
    }

    #dataset:hover {
      border-color: rgba(0, 224, 255, 0.8);
      transform: translateY(-1px);
    }

    #dataset:focus {
      box-shadow: 0 0 0 2px rgba(0, 224, 255, 0.5);
      border-color: rgba(0, 224, 255, 0.9);
    }

    /* âœ… ä¿®æ­£ï¼šæ·±è‰²æ¨¡å¼ä¸‹ <option> çš„æ¨£å¼ */
    #dataset option {
      background: var(--bg-deep, #050816); /* ç¢ºä¿æœ‰é è¨­æ·±è‰²èƒŒæ™¯ */
      color: var(--text-main, #f5f7ff);
    }
    
    /* âœ… ä¿®æ­£ï¼šäº®è‰²æ¨¡å¼ä¸‹ <option> çš„æ¨£å¼ */
    body.light-mode #dataset option {
      background: #ffffff;
      color: #1e293b;
    }

    #username {
      padding: 8px 12px;
      font-size: 0.95em;
      border-radius: 999px;
      /* âœ… ç§»é™¤é‚Šæ¡†ï¼Œæ”¹ç”¨èƒŒæ™¯è‰²å€åˆ† */
      border: 1px solid transparent;
      background: rgba(255, 255, 255, 0.05); /* ç»ç’ƒæ“¬æ…‹èƒŒæ™¯ */
      color: var(--text-main);
      min-width: 140px;
      outline: none;
      transition: box-shadow 0.2s ease, border-color 0.2s ease, transform 0.12s ease, background 0.2s ease;
    }

    body.light-mode #username {
      /* âœ… ç§»é™¤é‚Šæ¡†ï¼Œæ”¹ç”¨èƒŒæ™¯è‰²å€åˆ† (Light) */
      border: 1px solid transparent;
      background: rgba(0, 0, 0, 0.03);
    }

    #username::placeholder {
      color: rgba(148, 163, 184, 0.9);
      font-size: 0.9em;
    }

    #username:hover {
      transform: translateY(-1px);
    }

    #username:focus {
      box-shadow: 0 0 0 2px rgba(0, 224, 255, 0.45);
      border-color: rgba(0, 224, 255, 0.85);
    }

    #start-btn {
      margin-left: 4px;
      padding: 10px 22px; /* ç¨å¾®åŠ å¯¬ */
      font-size: 1.05em; /* ç¨å¾®åŠ å¤§ */
      border-radius: 999px;
      background: linear-gradient(120deg, var(--accent-cyan), var(--accent-lime));
      color: #111827;
      font-weight: 700;
      border: none;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(0, 224, 255, 0.4);
      transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
      white-space: nowrap;
    }


    #start-btn:hover {
      transform: translateY(-1px) scale(1.05);
      box-shadow: 0 12px 24px rgba(0, 224, 255, 0.55);
      filter: saturate(1.1);
    }


    #start-btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 4px 10px rgba(0, 224, 255, 0.3);
    }

    .hint-text {
      text-align: center;
      font-size: 0.85em;
      color: var(--text-muted);
      margin-top: 2px;
      margin-bottom: 12px;
      width: 100%; /* ç¢ºä¿å®ƒèƒ½ç½®ä¸­ */
    }



    body.light-mode .leaderboard-controls button {
      color: #ffffff;
      font-weight: 600;
    }

    body.light-mode #expand-all {
      background: linear-gradient(120deg, #38bdf8, #22c55e);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    body.light-mode #collapse-all {
      background: linear-gradient(120deg, #9ca3af, #6b7280);
      box-shadow: 0 4px 10px rgba(156, 163, 175, 0.5);
    }

    

    /* æš— / äº®æ¨¡å¼åˆ‡æ›æŒ‰éˆ• */
    .theme-toggle {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      font-size: 0.85em;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.7);
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.2s ease, color 0.2s ease;
    }

    .theme-toggle span {
      font-size: 1.05em;
    }

    .theme-toggle:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.8);
    }

    body.light-mode .theme-toggle {
      background: #ffffff;
      color: #0f172a;
      box-shadow: 0 6px 14px rgba(148, 163, 184, 0.7);
    }

    .progress-container {
      height: 18px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      margin: 16px 0 10px 0;
      overflow: hidden;
      /* âœ… ç§»é™¤é‚Šæ¡† */
      /* border: 1px solid rgba(148, 163, 184, 0.5); */
      box-shadow: inset 0 0 10px rgba(15, 23, 42, 0.9);
    }

    body.light-mode .progress-container {
      background: #e5e7eb;
      box-shadow: inset 0 0 4px rgba(148, 163, 184, 0.5);
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-lime));
      transition: width 0.3s ease-in-out;
      box-shadow: 0 0 16px rgba(0, 224, 255, 0.9);
    }

    .quiz {
      margin-top: 4px;
    }
    
    /* âœ… éŠæˆ² HUD æ¨£å¼ (Request 1) */
    .game-hud {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(15, 23, 42, 0.9); /* From .progress-container */
      border-radius: 999px;
      margin: 1.5em 0 1.5em 0; /* âœ… èª¿æ•´ margin (ä¸Šä¸‹é‚Šè·) */
      padding: 8px 20px;
      /* âœ… ç§»é™¤é‚Šæ¡† */
      /* border: 1px solid rgba(148, 163, 184, 0.5); */
    }
    .hud-item {
       /* empty */
    }
    #score-display-container {
      text-align: left;
    }
    #lives-display-container {
      text-align: right;
    }
    .hud-label {
      font-size: 0.85em;
      color: var(--text-muted);
      display: block; 
    }
    .hud-value {
      font-weight: 700;
      display: block; 
    }
    #score-display {
      font-size: 1.3em;
      color: var(--accent-lime);
    }
    #lives-display {
      font-size: 1.2em; /* Hearts */
      color: var(--danger);
      letter-spacing: 2px;
    }
    body.light-mode .game-hud {
      background: #e5e7eb;
      box-shadow: inset 0 0 4px rgba(148, 163, 184, 0.5);
    }
    /* ç§»é™¤èˆŠæ¨£å¼ */
    .score-display, .lives-display {
       display: none; /* å·²è¢« .game-hud å–ä»£ */
    }

    
    /* âœ… é¡Œç›®ç¾åŒ– (Request 1) */
    .question {
      font-size: 1.6em; /* æ”¾å¤§ */
      font-weight: 700;  /* åŠ ç²— */
      margin: 0.8em 0 0.5em 0; /* èª¿æ•´ margin */
      text-align: center;
      color: #ffffff; /* æ”¹ç‚ºç´”ç™½ */
      padding: 8px 10px;
      line-height: 1.6;
      text-shadow: 0 0 8px rgba(0, 224, 255, 0.5); /* å¢åŠ ä¸€é»å…‰æšˆ */
    }

    body.light-mode .question {
      color: #0f172a;
      text-shadow: none; /* äº®è‰²æ¨¡å¼ä¸éœ€è¦å…‰æšˆ */
    }

    .options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .options button {
      padding: 14px 10px;
      font-size: 1.02em;
      font-weight: 600;
      border: none;
      border-radius: 18px;
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.36), rgba(15, 23, 42, 0.96));
      color: var(--text-main);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.6);
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease, filter 0.15s ease;
      cursor: pointer;
      text-align: center;
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
    }

    body.light-mode .options button {
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.3), #ffffff);
      color: #0f172a;
      box-shadow: 0 4px 10px rgba(148, 163, 184, 0.9);
    }

    .options button:hover:not(:disabled) {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.9);
      filter: brightness(1.05);
      background: radial-gradient(circle at top left, rgba(248, 250, 252, 0.2), rgba(17, 24, 39, 0.98));
    }

    body.light-mode .options button:hover:not(:disabled) {
      box-shadow: 0 8px 16px rgba(148, 163, 184, 0.8);
      background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.9), #e5e7eb);
    }

    .options button:disabled {
      cursor: default;
      opacity: 0.9;
    }

    .options button.correct {
      background: linear-gradient(135deg, var(--success), #9bffcd);
      color: #052e16;
      box-shadow: 0 0 18px rgba(0, 255, 157, 0.9);
      animation: correctPop 0.28s ease-out;
    }

    .options button.incorrect {
      background: linear-gradient(135deg, var(--danger), #ff9aa2);
      color: #fff7f7;
      box-shadow: 0 0 16px rgba(255, 56, 96, 0.9);
      animation: wrongShake 0.26s ease-in-out;
    }

    @keyframes correctPop {
      0% { transform: scale(0.9); }
      60% { transform: scale(1.06); }
      100% { transform: scale(1.0); }
    }

    @keyframes wrongShake {
      0% { transform: translateX(0); }
      20% { transform: translateX(-4px); }
      40% { transform: translateX(4px); }
      60% { transform: translateX(-3px); }
      80% { transform: translateX(3px); }
      100% { transform: translateX(0); }
    }

    .result-log {
      margin-top: 24px;
      padding-left: 20px;
      max-height: 260px;
      overflow-y: auto;
    }

    .result-log li {
      margin: 8px 0; /* å¢åŠ è¡Œè·ä»¥å®¹ç´ç¿»è­¯ */
      font-size: 0.9em;
      color: var(--text-muted);
      line-height: 1.5;
    }
    
    .result-log li small {
      font-size: 0.95em;
    }

    #result-title {
      margin-top: 24px;
      font-size: 1.05em;
      color: var(--accent-cyan);
    }

    .badges {
      margin-top: 18px;
      text-align: center;
      font-size: 0.9em;
      color: var(--text-muted);
    }

    .badges span {
      display: inline-block;
      padding: 8px 14px;
      margin: 4px;
      background: radial-gradient(circle at top, #facc15, #f97316);
      color: #1f2937;
      border-radius: 999px;
      font-size: 0.88em;
      box-shadow: 0 6px 14px rgba(250, 204, 21, 0.35);
      font-weight: 600;
    }

    .leaderboard {
      margin-top: 24px;
      padding: 18px 16px 10px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 1), rgba(3, 7, 18, 0.98));
      border-radius: 20px;
      /* âœ… ç§»é™¤é‚Šæ¡† */
      /* border: 1px solid rgba(148, 163, 184, 0.6); */
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.88);
    }

    body.light-mode .leaderboard {
      background: linear-gradient(180deg, #ffffff, #e5e7eb);
      box-shadow: 0 10px 22px rgba(148, 163, 184, 0.7);
    }

    .leaderboard h2 {
      text-align: center;
      color: var(--accent-cyan);
      font-size: 1.5em;
      margin-top: 0;
      margin-bottom: 8px;
      text-shadow: 0 0 8px rgba(0, 224, 255, 0.9);
    }

    body.light-mode .leaderboard h2 {
      text-shadow: none;
    }

    .leaderboard-note {
      text-align: center;
      font-size: 0.8em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .leaderboard-controls {
      text-align: center;
      margin: 10px 0 6px 0;
    }

    .leaderboard-controls button {
      padding: 6px 12px;
      margin: 0 6px;
      border-radius: 999px;
      border: none;
      font-size: 0.85em;
      cursor: pointer;
      color: #0b1120;
      font-weight: 500;
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }

    #expand-all {
      background: linear-gradient(120deg, var(--accent-cyan), var(--accent-lime));
      box-shadow: 0 8px 16px rgba(0, 224, 255, 0.5);
    }

    #collapse-all {
      background: linear-gradient(120deg, #9ca3af, #6b7280);
      box-shadow: 0 6px 12px rgba(107, 114, 128, 0.6);
    }

    .leaderboard-controls button:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
    }

    .leaderboard-controls button:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: none;
    }

    .leaderboard-loading {
      text-align: center;
      margin: 8px 0 10px 0;
      color: var(--text-muted);
      font-size: 0.9em;
    }

    .leaderboard-loading .spinner {
      margin: 6px auto 4px;
      border: 4px solid rgba(148, 163, 184, 0.25);
      border-top: 4px solid var(--accent-cyan);
      border-radius: 50%;
      width: 34px;
      height: 34px;
      animation: spin 0.9s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .leaderboard ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .leaderboard li {
      font-size: 0.95em;
      color: var(--text-main);
    }

    .dataset-block {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 12px;
      /* âœ… ç§»é™¤é‚Šæ¡†ï¼Œæ”¹ç”¨é™°å½± */
      /* border: 1px solid rgba(148, 163, 184, 0.8); */
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      margin-top: 10px;
      padding: 6px 8px 4px;
    }

    body.light-mode .dataset-block {
      background: #f1f5f9; /* è¼•å¾®åŠ æ·±èƒŒæ™¯ */
      border-color: rgba(148, 163, 184, 0.9);
      box-shadow: 0 3px 8px rgba(148, 163, 184, 0.3);
    }

    .dataset-block summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--accent-cyan);
      font-size: 0.98em;
      outline: none;
      list-style: none;
    }

    .dataset-block summary::-webkit-details-marker {
      display: none;
    }

    .dataset-block summary::before {
      content: "â–¶";
      font-size: 0.8em;
      margin-right: 6px;
      color: var(--accent-lime);
      transition: transform 0.16s ease;
      display: inline-block;
    }

    .dataset-block[open] summary::before {
      transform: rotate(90deg);
    }

    .dataset-block small {
      color: var(--text-muted);
      font-weight: 400;
      font-size: 0.78em;
    }
    
    /* âœ… ä¿®æ­£ï¼šæ’è¡Œæ¦œæ¨£å¼ (Request 4) */
    .dataset-block ul {
      list-style: none;
      padding: 6px 0 4px 0px; /* é‡è¨­ padding-left */
      margin: 0;
    }
    
    .rank-item {
      display: flex;
      align-items: center;
      padding: 10px 8px;
      /* âœ… ç§»é™¤åº•ç·š */
      /* border-bottom: 1px solid rgba(31, 41, 55, 0.9); */
    }
    .rank-item:last-child {
      border-bottom: none;
    }
    .rank-position {
      font-size: 1.2em;
      font-weight: 700;
      width: 40px;
      flex-shrink: 0;
      text-align: center;
    }
    .rank-details {
      flex-grow: 1;
      margin-left: 8px;
    }
    .rank-username {
      display: block;
      font-weight: 600;
      font-size: 0.95em;
      color: var(--text-main);
    }
    .rank-time {
      display: block;
      font-size: 0.8em;
      color: var(--text-muted);
    }
    .rank-score {
      font-size: 1.1em;
      font-weight: 700;
      color: var(--accent-cyan);
      padding-left: 10px;
    }

    /* Top 3 é«˜äº® */
    .rank-1 .rank-position { color: var(--gold); }
    .rank-1 .rank-username { color: var(--gold); }
    .rank-1 .rank-score { color: var(--gold); }
    
    .rank-2 .rank-position { color: var(--silver); }
    .rank-2 .rank-username { color: var(--silver); }

    .rank-3 .rank-position { color: var(--bronze); }
    .rank-3 .rank-username { color: var(--bronze); }

    /* Light mode */
    body.light-mode .rank-item {
      /* âœ… ç§»é™¤åº•ç·š */
      border-bottom-color: transparent;
    }
    
    .footer {
      margin-top: 14px;
      font-size: 0.8em;
      color: #94a3b8;
      text-align: center;
    }

    @media (max-width: 640px) {
      body {
        margin: 12px auto;
        padding: 10px;
      }
      .game-card {
        padding: 16px 14px 22px;
        border-radius: 18px;
      }
      h1 {
        font-size: 1.7em;
      }
      .options {
        grid-template-columns: 1fr;
      }
      .control-row {
        flex-direction: column;
        align-items: stretch;
      }
      #start-btn {
        margin-left: 0;
        align-self: center;
      }
      .theme-toggle {
        top: 10px;
        right: 10px;
      }
      
      /* âœ… RWD for HUD */
      .game-hud {
        padding: 6px 16px;
      }
      .hud-label {
        font-size: 0.8em;
      }
      #score-display {
        font-size: 1.2em;
      }
      #lives-display {
        font-size: 1.1em;
      }

      /* âœ… RWD for Rank */
      .rank-position {
        width: 35px;
        font-size: 1.1em;
      }
      .rank-details {
        margin-left: 4px;
      }
      .rank-username {
        font-size: 0.9em;
      }
      .rank-time {
        font-size: 0.75em;
      }
      .rank-score {
        font-size: 1.0em;
      }
    }
/* === äº®è‰²æ¨¡å¼ä¸‹é¸é …æŒ‰éˆ•ä¿®æ­£ç‰ˆï¼šæé«˜æ–‡å­—å°æ¯” === */
body.light-mode .options button.correct {
  background: linear-gradient(135deg, #4ade80, #22c55e); /* æ›´é£½å’Œçš„ç¶  */
  color: #ffffff; /* æ”¹ç‚ºç™½å­— */
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3); /* å¢åŠ ç«‹é«”åº¦ */
  box-shadow: 0 0 12px rgba(34, 197, 94, 0.5);
}

body.light-mode .options button.incorrect {
  background: linear-gradient(135deg, #f87171, #ef4444);
  color: #ffffff;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
  box-shadow: 0 0 12px rgba(239, 68, 68, 0.5);
}
    

/* === âœ… äº®è‰²æ¨¡å¼æŒ‰éˆ•è¦†è“‹ä¿®æ­£ç‰ˆ === */
body.light-mode #start-btn {
  background: linear-gradient(120deg, #38bdf8, #22c55e) !important;
  color: #ffffff !important;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4) !important;
}

body.light-mode #start-btn:hover {
  background: linear-gradient(120deg, #60a5fa, #4ade80) !important;
  transform: translateY(-1px) scale(1.05) !important;
  filter: brightness(1.1) !important;
  box-shadow: 0 6px 16px rgba(59, 130, 246, 0.6) !important;
}

body.light-mode #start-btn:active {
  background: linear-gradient(120deg, #3b82f6, #22c55e) !important;
  transform: translateY(1px) scale(0.98) !important;
  box-shadow: 0 3px 8px rgba(59, 130, 246, 0.4) !important;
}

  </style>
</head>
<body>
  <div class="game-card">
    <button id="theme-toggle" class="theme-toggle" type="button">
      <span class="icon">ğŸŒ™</span>
      <span class="label">æš—è‰²æ¨¡å¼</span>
    </button>

    <!-- ========= NEW LAYOUT START ========= -->

    <!-- 1. é¡Œåº«é¸æ“‡ -->
    <div class="control-row" style="margin-top: 10px; margin-bottom: 16px;">
      <label for="dataset">é¡Œåº«é¸æ“‡ï¼š</label>
      <select id="dataset">
        <!-- âœ… 2025/11/11 æ›´æ–°é¡Œåº«åˆ—è¡¨ -->
        <option value="sentence_gept0304.json" data-limit="all" data-quiz-type="sentence">ğŸŸ¡ GEPT ç¬¬ä¸‰å›+ç¬¬å››å› (é€ å¥) </option>
        <option value="GEPT_20251109.json" data-limit="all" data-quiz-type="vocab">ğŸŒ GEPT ç¬¬ä¸‰å›+ç¬¬å››å› (å–®å­—)</option>
        <option value="sentences_week1.json" data-limit="all" data-quiz-type="sentence">ğŸŸ¡ Week 1 (é€ å¥) </option>
        <option value="sentences_week2.json" data-limit="all" data-quiz-type="sentence">ğŸŸ¡ Week 2 (é€ å¥) </option>
        <option value="week1.json" data-limit="all" data-quiz-type="vocab">ğŸŸ¡ Week 1 (ä¸»é¡Œèª²æ–‡25é¡Œ)</option>
        <option value="week2.json" data-limit="all" data-quiz-type="vocab">ğŸŸ¡ Week 2 (ä¸»é¡Œèª²æ–‡30é¡Œ)</option>
        <option value="week2-bonus.json" data-limit="25" data-quiz-type="vocab">âœ¨ Week 2 (æ“´å……æŒ‘æˆ°25/50)</option>
        <option value="GEPT_Stage3.json" data-limit="50" data-quiz-type="vocab">ğŸ¤© æ“´å……æŒ‘æˆ°Lv.3 (50/50)</option>
        <option value="GEPT_Week3_Vocab.json" data-limit="all" data-quiz-type="vocab">ğŸ¤© æ“´å……æŒ‘æˆ°Lv.3 (å–®å­—)</option>
        <option value="gept-full.json" data-limit="25" data-quiz-type="vocab">ğŸ”µ å…¨ GEPT (éš¨æ©ŸæŒ‘æˆ°25/2256)</option>
        <option value="gept-full.json" data-limit="all" data-quiz-type="vocab">ğŸ”µ å…¨ GEPT (é­”é¬¼æŒ‘æˆ°2256é¡Œ)</option>
      </select>
    </div>

    <!-- 2. ç©å®¶æš±ç¨± -->
    <div class="control-row" id="username-row" style="margin-bottom: 20px;">
      <label for="username">ç©å®¶æš±ç¨±ï¼š</label>
      <input id="username" type="text" placeholder="ä¾‹å¦‚ï¼šEmmett" />
    </div>

    <!-- 3. å¤§æ¨™é¡Œ -->
    <h1 id="main-title" style="margin-top: 16px;">GEPT Vocabulary Battle âš¡</h1>
    
    <!-- 4. å°èªªæ˜ -->
    <div class="subtitle" id="main-subtitle">è½ç™¼éŸ³ã€é¸ä¸­æ–‡ï¼Œçœ‹çœ‹ä½ èƒ½å®ˆä½å¹¾æ¢å‘½ï¼</div>
    
    <!-- 5. é–‹å§‹æŒ‘æˆ°æŒ‰éˆ• -->
    <div class="control-row" style="margin-top: 20px; flex-direction: column;"> <!-- å¢åŠ ä¸€é» margin-top è£œå„Ÿ -->
      <!-- <div class="hint-text" id="main-hint" style="margin-top: 0; margin-bottom: 12px;">å°æç¤ºï¼šé–‹å§‹å¾ŒæŒ‰éˆ•å¯é‡è½ç™¼éŸ³ ğŸ§</div> --> <!-- âœ… ç§»é™¤æç¤º -->
      <button id="start-btn" onclick="startQuiz()">é–‹å§‹æŒ‘æˆ°</button>
    </div>
    
    <!-- ========= NEW LAYOUT END ========= -->


    <div class="progress-container" style="display:none;" id="progress-section">
      <div class="progress-bar" id="progress-bar"></div>
    </div>

    <div class="quiz" style="display:none;">
      
      <div class="question" id="question"></div>

      <div class="score-display" id="score-display-old"></div>
      <div class="lives-display" id="lives-display-old"></div>
      
      <div class="options" id="options"></div>

      <div class="game-hud">
        <div class="hud-item" id="score-display-container">
          <span class="hud-label">ç›®å‰å¾—åˆ†</span>
          <span class="hud-value" id="score-display">0</span>
        </div>
        <div class="hud-item" id="lives-display-container">
          <span class="hud-label">å‰©é¤˜ç”Ÿå‘½</span>
          <span class="hud-value" id="lives-display">â¤ï¸â¤ï¸â¤ï¸</span>
        </div>
      </div>
      
      <h3 id="result-title" style="margin-top:30px;"></h3>
      <ul class="result-log" id="results"></ul>
      <div class="badges" id="badges"></div>
    </div>

    <div class="leaderboard" id="leaderboard">
      <h2>ğŸ† ç©åˆ†æ’è¡Œæ¦œ</h2>
      <div class="leaderboard-note">ä¾é¡Œåº«åˆ†çµ„ï¼Œæ¯çµ„é¡¯ç¤ºå‰ 10 åç´€éŒ„ï¼ˆä¾å®Œæˆæ™‚é–“æ’åºï¼‰</div>

      <div id="leaderboard-loading" class="leaderboard-loading">
        <div class="spinner"></div>
        <div>æ’è¡Œæ¦œè¼‰å…¥ä¸­â€¦</div>
      </div>

      <ul id="leaderboard-list"></ul>
    </div>
  </div>

  <div class="footer">
    Made by Evelyn YT ï½œÂ© 2025/11/11 (Layout & Translation Update)
  <div>

  <script>
// æ‚¨çš„ Google Apps Script ç¶²å€ä¿æŒä¸è®Š
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyg8OvuiCZbrtUTBy6a1pKyWeGUZJJbCJsxeodvwgbs9I2o6Fe7dS_irIntu44SNmJrig/exec";

let selectedVoice = null;
let badgesEarned = JSON.parse(localStorage.getItem("badges")) || [];

function findEnglishVoice() {
  const voices = speechSynthesis.getVoices();
  const priority = ['Google US English', 'Samantha', 'Microsoft Aria Online (Natural) - English (United States)', 'Microsoft Zira', 'Microsoft David', 'Karen', 'Alex'];
  for (const name of priority) {
    const match = voices.find(v => v.name.includes(name));
    if (match) return match;
  }
  return voices.find(v => v.lang === 'en-US') || voices[0];
}

speechSynthesis.onvoiceschanged = () => {
  selectedVoice = findEnglishVoice();
};

// é è¨­é¡Œåº« (æ ¹æ“š <select> é †åºï¼Œæ”¹ç‚º sentence)
let data = [
  { "sentence": "Default ________.", "answer": "question", "distractors": ["a", "b", "c"], "chinese": "é è¨­å•é¡Œã€‚" }
];

let defaultData = [...data];
let questionSet = [];
let currentIndex = 0;
let attempts = 0;
let wrongCount = 0;
let totalQuestionsToComplete = "all";
let score = 0;
let lives = 3;
let gameSession = Date.now();
let currentQuizType = "sentence"; // æ ¹æ“šæ–°çš„ <select> é †åºï¼Œé è¨­æ”¹ç‚º sentence
let currentDatasetFile = ""; // è¿½è¹¤ç›®å‰é¸æ“‡çš„æª”æ¡ˆ

function shuffle(array) {
  return array.sort(() => Math.random() - 0.5);
}

function updateProgressBar() {
  const totalQuestions = typeof totalQuestionsToComplete === 'number' ?
                       totalQuestionsToComplete : questionSet.length;
  const percent = (currentIndex / totalQuestions) * 100;
  document.getElementById("progress-bar").style.width = `${percent}%`;
}

// âœ… ä¿®æ­£ï¼šæ›´æ–° HUD
function updateScoreDisplay() {
  document.getElementById("score-display").innerText = score;
}

// âœ… ä¿®æ­£ï¼šæ›´æ–° HUD
function updateLivesDisplay() {
  const hearts = 'â¤ï¸'.repeat(lives);
  document.getElementById("lives-display").innerText = hearts;
}

let sessionBadges = []; // ç”¨ä¾†è¨˜éŒ„æœ¬æ¬¡æŒ‘æˆ°æ–°å¢çš„å¾½ç« 

// æ•´åˆå¾Œçš„å¾½ç« ç³»çµ±
function awardBadges() {
  const newBadges = [];
  
  // å…±åŒå¾½ç« 
  if (!badgesEarned.includes("ğŸ‰ é¦–æ¬¡æŒ‘æˆ°")) newBadges.push("ğŸ‰ é¦–æ¬¡æŒ‘æˆ°");
  if (wrongCount === 0 && (currentIndex === questionSet.length || currentIndex === totalQuestionsToComplete)) {
    newBadges.push("â­ å®Œç¾æŒ‘æˆ°");
  }

  // æ ¹æ“šä¸åŒæ¨¡å¼çµ¦äºˆç‰¹å®šå¾½ç« 
  if (currentQuizType === "vocab") {
    if (score >= 100) newBadges.push("ğŸ–ï¸ å–®å­—é”äºº");
  } else if (currentQuizType === "sentence") {
    if (score >= 100) newBadges.push("ğŸ–ï¸ é€ å¥é«˜æ‰‹"); // é€ å¥æŒ‘æˆ°çš„åˆ†æ•¸é–€æª»
  }

  // åˆ¤æ–·å“ªäº›å¾½ç« æ˜¯æœ¬æ¬¡æ–°ç²å¾—çš„
  sessionBadges = newBadges.filter(badge => !badgesEarned.includes(badge));

  // æ›´æ–°æ°¸ä¹…å¾½ç« 
  sessionBadges.forEach(badge => badgesEarned.push(badge));
  localStorage.setItem("badges", JSON.stringify(badgesEarned));
}

// é¡¯ç¤ºæ°¸ä¹…å¾½ç« 
function displayBadges() {
  const badgesContainer = document.getElementById("badges");
  if (!badgesContainer) return;
  badgesContainer.innerHTML = badgesEarned.length
    ? badgesEarned.map(badge => `<span>${badge}</span>`).join("")
    : "å°šæœªç²å¾—å¾½ç« ";
}

async function submitScore() {
  if (!GOOGLE_SCRIPT_URL.includes("YOUR")) {
    try {
      await fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username: window.username,
          score: score,
          session: gameSession,
          dataset: document.getElementById("dataset").options[document.getElementById("dataset").selectedIndex].text
        })
      });

      console.log("åˆ†æ•¸å·²æäº¤è‡³ Google Sheets");
    } catch (err) {
      console.error("æäº¤åˆ†æ•¸å¤±æ•—:", err);
    }
  } else {
    console.warn("æœªè¨­ç½® GOOGLE_SCRIPT_URLï¼Œåˆ†æ•¸æœªæäº¤");
  }
}

// ===============================================
// âœ… Bug ä¿®æ­£ï¼šspeak å‡½æ•¸ (Request 2)
// ===============================================

/**
 * æœ—è®€æŒ‡å®šçš„æ–‡å­—
 * @param {string} text - è¦æœ—è®€çš„å…§å®¹
 * @param {function} [callback] - (å¯é¸) æœ—è®€å®Œç•¢å¾Œè¦åŸ·è¡Œçš„å‡½æ•¸
 */
function speak(text, callback) {
  try {
    speechSynthesis.cancel();
    if (!selectedVoice) selectedVoice = findEnglishVoice();
    
    // âœ… Bug ä¿®æ­£ï¼šæ‹¼å¯«éŒ¯èª¤ (Fance -> Utterance)
    const utterance = new SpeechSynthesisUtterance(text);
    
    utterance.voice = selectedVoice;
    utterance.lang = "en-US";
    utterance.rate = 0.9;

    // æœ—è®€çµæŸæ™‚ï¼ŒåŸ·è¡Œ callback
    utterance.onend = function() {
      if (callback) {
        callback();
      }
    };

    // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œä¹ŸåŸ·è¡Œ callback (é¿å…éŠæˆ²å¡ä½)
    utterance.onerror = function(event) {
      console.error('Speech synthesis error:', event);
      if (callback) {
        callback(); // ç¢ºä¿éŒ¯èª¤æ™‚ä¹Ÿèƒ½æ¨é€²éŠæˆ²
      }
    };

    speechSynthesis.speak(utterance);
  } catch (err) {
    console.error("Speak function error:", err);
    if (callback) {
        callback(); // æ•æ‰åŒæ­¥éŒ¯èª¤ (ä¾‹å¦‚ .speak() å¤±æ•—)
    }
  }
}


async function fetchLeaderboard() {
  const loadingEl = document.getElementById("leaderboard-loading");
  const leaderboardList = document.getElementById("leaderboard-list");

  if (loadingEl) {
    loadingEl.style.display = "block";
  }
  if (leaderboardList) {
    leaderboardList.innerHTML = "";
  }

  if (!GOOGLE_SCRIPT_URL.includes("YOUR")) {
    try {
      const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getLeaderboard`);
      const leaderboard = await response.json();

      const grouped = {};
      leaderboard.forEach(entry => {
        const key = entry.dataset || "æœªçŸ¥é¡Œåº«";
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(entry);
      });

      // æ¯å€‹é¡Œåº«å…§ä¾ã€Œåˆ†æ•¸é«˜â†’ä½ã€æ’åºï¼Œè‹¥åŒåˆ†å‰‡ä»¥æ™‚é–“æ–°â†’èˆŠæ’åº
      for (const key in grouped) {
        grouped[key].sort((a, b) => {
          if (b.score === a.score) {
            return new Date(b.timestamp) - new Date(a.timestamp);
          }
          return b.score - a.score;
        });
          // åªä¿ç•™å‰10å
        grouped[key] = grouped[key].slice(0, 10);
      }

      // é¡Œåº«ä¾ã€Œæœ€æ–°ç´€éŒ„æ™‚é–“æ–°â†’èˆŠã€æ’åº
      const sortedDatasets = Object.keys(grouped).sort((a, b) => {
        const latestA = Math.max(...grouped[a].map(e => new Date(e.timestamp)));
        const latestB = Math.max(...grouped[b].map(e => new Date(e.timestamp)));
        return latestB - latestA;
      });

      const expandedDatasets = sortedDatasets.slice(0, 1);
      const datasetSelect = document.getElementById("dataset");
      window.datasetCache = window.datasetCache || {};

      let html = `
        <div class="leaderboard-controls">
          <button id="expand-all">å±•é–‹å…¨éƒ¨</button>
          <button id="collapse-all">å…¨éƒ¨æ”¶èµ·</button>
        </div>
      `;

      for (const dataset of sortedDatasets) {
        const entries = grouped[dataset];
        const isOpen = expandedDatasets.includes(dataset) ? "open" : "";

        let questionCount = 0;
        try {
          // âœ… ä¿®æ­£ï¼šä½¿ç”¨ .includes() 
          const option = Array.from(datasetSelect.options).find(
            opt => opt.text.trim().includes(dataset.trim())
          );
          
          if (option) {
            const file = option.value;
            if (window.datasetCache[file]) {
              questionCount = window.datasetCache[file].length;
            } else {
              const res = await fetch(file);
              if (res.ok) {
                const q = await res.json();
                window.datasetCache[file] = q;
                questionCount = q.length;
              }
            }
          }
        } catch (err) {
          console.warn("ç„¡æ³•è¼‰å…¥é¡Œåº«é¡Œæ•¸:", dataset, err);
        }

        // æ»¿åˆ†é‚è¼¯
        let fullScore = "ï¼Ÿ";
        try {
          // âœ… ä¿®æ­£ï¼šä½¿ç”¨ .includes() 
          const option = Array.from(datasetSelect.options).find(
            opt => opt.text.trim().includes(dataset.trim())
          );
          
          if (option) {
            const limitAttr = option.getAttribute("data-limit");
            if (limitAttr && limitAttr !== "all") {
              // è‹¥æœ‰ data-limit å±¬æ€§ï¼ˆä¾‹ï¼š25 é¡Œï¼‰
              fullScore = parseInt(limitAttr) * 5;
            } else if (questionCount > 0) {
              // å¦å‰‡ç”¨é¡Œåº«å¯¦éš›é¡Œæ•¸
              fullScore = questionCount * 5;
            }
          } else if (questionCount > 0) {
            fullScore = questionCount * 5;
          }
        } catch (e) {
          console.warn("è¨ˆç®—æ»¿åˆ†æ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
        }

        html += `
          <li style="list-style:none; margin-top:10px;">
            <details ${isOpen} class="dataset-block">
              <summary>
                ğŸ“˜ ${dataset}
                <small>ï¼ˆæ»¿åˆ† ${fullScore} åˆ†ï¼‰</small>
              </summary>
              <ul>
                ${entries.map((entry, index) => {
                  let rankClass = 'rank-normal';
                  let rankIcon = `<span style="font-size: 0.9em; color: var(--text-muted);">${index + 1}.</span>`;
                  if (index === 0) { rankClass = 'rank-1'; rankIcon = 'ğŸ¥‡'; }
                  if (index === 1) { rankClass = 'rank-2'; rankIcon = 'ğŸ¥ˆ'; }
                  if (index === 2) { rankClass = 'rank-3'; rankIcon = 'ğŸ¥‰'; }

                  return `
                  <li class="rank-item ${rankClass}">
                    <div class="rank-position">${rankIcon}</div>
                    <div class="rank-details">
                      <span class="rank-username">${entry.username}</span>
                      <span class="rank-time">${new Date(entry.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="rank-score">${entry.score}åˆ†</div>
                  </li>
                  `
                }).join("")}
              </ul>
            </details>
          </li>
        `;
      }

      leaderboardList.innerHTML = html;

      const expandAllBtn = document.getElementById("expand-all");
      const collapseAllBtn = document.getElementById("collapse-all");

      if (expandAllBtn) {
        expandAllBtn.addEventListener("click", () => {
          document.querySelectorAll(".dataset-block").forEach(el => (el.open = true));
        });
      }

      if (collapseAllBtn) {
        collapseAllBtn.addEventListener("click", () => {
          document.querySelectorAll(".dataset-block").forEach(el => (el.open = false));
        });
      }

      if (loadingEl) {
        loadingEl.style.display = "none";
      }
    } catch (err) {
      console.error("è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:", err);
      if (leaderboardList) {
        leaderboardList.innerHTML = "<li>ç„¡æ³•è¼‰å…¥æ’è¡Œæ¦œ</li>";
      }
      if (loadingEl) {
        loadingEl.style.display = "none";
      }
    }
  } else {
    if (leaderboardList) {
      leaderboardList.innerHTML = "<li>è«‹è¨­ç½® Google Sheets é€£çµ</li>";
    }
    if (loadingEl) {
      loadingEl.style.display = "none";
    }
  }
}

function endGame() {
  updateProgressBar();
  awardBadges(); // çµç®—å¾½ç« 
  submitScore();
  fetchLeaderboard();

  // çµæŸç•«é¢ï¼šåƒ…é¡¯ç¤ºã€Œæœ¬æ¬¡ç²å¾—å¾½ç« ã€
  const quizEl = document.querySelector(".quiz");
  quizEl.innerHTML = `
    <h2>ğŸ‰ ${window.username}ï¼Œæœ¬æ¬¡æŒ‘æˆ°çµæŸï¼</h2>
    <h3>ç¸½å¾—åˆ†ï¼š${score}</h3>
    <h3 id="result-title" style="margin-top:30px;">${window.username} çš„æŒ‘æˆ°çµæœï¼š</h3>
    <ul class="result-log" id="results">${document.getElementById("results").innerHTML}</ul>
    <div id="session-badges" style="margin-top: 25px; text-align: center;"></div>
    <div style="text-align: center; margin-top: 20px;">
      <button onclick="location.reload()" style="
        padding: 12px 24px;
        font-size: 1em;
        border: none;
        border-radius: 30px;
        background: linear-gradient(to right, #ff9f1a, #ffc107);
        color: #333;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 4px 4px 10px rgba(0,0,0,0.1);
      ">ğŸ” å†ç©ä¸€æ¬¡</button>
    </div>`;

  // âœ… é¡¯ç¤ºã€Œæœ¬æ¬¡ç²å¾—å¾½ç« ã€
  const sessionContainer = document.getElementById("session-badges");
  if (sessionBadges.length > 0) {
    sessionContainer.innerHTML = `
      <h3 style="color:#ffd700;">ğŸ¯ æœ¬æ¬¡ç²å¾—å¾½ç« </h3>
      ${sessionBadges
        .map(
          (b) => `
          <span style="
            display:inline-block;
            margin:6px;
            padding:8px 14px;
            border-radius:20px;
            background:#ffb703;
            color:#222;
            font-weight:600;
            box-shadow:2px 2px 6px rgba(0,0,0,0.2);
          ">${b}</span>`
        )
        .join("")}`;
  } else {
    sessionContainer.innerHTML = `<h3 style="color:#aaa;">æœ¬æ¬¡æœªç²å¾—æ–°å¾½ç« </h3>`;
  }
}

// ===============================================
// éŠæˆ²æ¨¡å¼ 1: å–®å­—æŒ‘æˆ° (Vocab)
// ===============================================

function renderVocabQuestion() {
  const container = document.getElementById("options");
  if (container) {
    container.innerHTML = ""; // æ¸…ç©ºèˆŠæŒ‰éˆ•
  }
  
  attempts = 0;
  updateProgressBar();
  updateScoreDisplay();
  const q = questionSet[currentIndex];
  document.getElementById("question").innerText = `"${q.Vocabulary}" æ˜¯ä»€éº¼æ„æ€ï¼Ÿ`;
  
  speak(q.Vocabulary); // å¿µå‡ºå–®å­— (ä¸éœ€ callback)

  const allChineseAnswers = data.map(item => item.Chinese);
  const correctAnswer = q.Chinese;

  const possibleDistractors = allChineseAnswers.filter(chinese => chinese !== correctAnswer);
  const distractors = shuffle(possibleDistractors).slice(0, 3);
  const choices = shuffle([correctAnswer, ...distractors]).map(chinese => ({ Chinese: chinese }));

  choices.forEach((choice) => {
    const btn = document.createElement("button");
    btn.innerText = choice.Chinese;
    btn.onclick = () => handleVocabChoice(btn, choice);
    container.appendChild(btn);
  });
}

function handleVocabChoice(button, choice) {
  const correctAnswer = questionSet[currentIndex].Chinese;
  attempts++;

  if (choice.Chinese === correctAnswer) {
    button.classList.add("correct");
    document.querySelectorAll(".options button").forEach(btn => btn.disabled = true);
    if (currentIndex === 0 && !document.getElementById("result-title").innerText) {
      document.getElementById("result-title").innerText = `${window.username} çš„æŒ‘æˆ°çµæœï¼š`;
    }
    
    // âœ… 2025/11/11 ç­”é¡Œç´€éŒ„æ”¹ç‚ºé¡¯ç¤ºåœ¨æœ€ä¸Šæ–¹
    const logEntry = (attempts === 1
        ? `<li>âœ… ${questionSet[currentIndex].Vocabulary} â€” ${questionSet[currentIndex].Chinese} â€” ${attempts} æ¬¡ â€” +5åˆ†</li>`
        : `<li style="color: #facc15;">ğŸŸ¡ ${questionSet[currentIndex].Vocabulary} â€” ${questionSet[currentIndex].Chinese} â€” ${attempts} æ¬¡ â€” 0åˆ†</li>`);
    document.getElementById("results").innerHTML = logEntry + document.getElementById("results").innerHTML;

    if (attempts === 1) {
      score += 5;
    }
    updateScoreDisplay();

    // å–®å­—æŒ‘æˆ°ä½¿ç”¨å›ºå®šå»¶é²ï¼Œæ„Ÿè¦ºè¼ƒæ˜å¿«
    setTimeout(() => {
      currentIndex++;
      const quizCompleted = typeof totalQuestionsToComplete === 'number' 
                          ? currentIndex >= totalQuestionsToComplete 
                          : currentIndex >= questionSet.length;

      if (!quizCompleted && wrongCount < 3) {
        renderQuestion(); // å‘¼å«ä¸»è·¯ç”±å™¨
      } else {
        endGame();
      }
    }, 800);
  } else {
    button.classList.add("incorrect");
    button.disabled = true;
    wrongCount++;
    lives = 3 - wrongCount;
    updateLivesDisplay();
    if (lives <= 0) {
      setTimeout(() => {
        endGame();
      }, 800);
    }
  }
}

// ===============================================
// éŠæˆ²æ¨¡å¼ 2: é€ å¥æŒ‘æˆ° (Sentence)
// ===============================================

function renderSentenceQuestion() {
  const container = document.getElementById("options");
  if (container) {
    container.innerHTML = ""; // æ¸…ç©ºèˆŠæŒ‰éˆ•
  }
  
  attempts = 0;
  updateProgressBar();
  updateScoreDisplay();
  const q = questionSet[currentIndex];
  
  // âœ… ä¿®æ­£ï¼šä½¿ç”¨ <span> æ­é… monospace
  const questionHTML = q.sentence.replace(
    "________", 
    '<span style="font-family: monospace; letter-spacing: -1px;">________</span>'
  );
  document.getElementById("question").innerHTML = questionHTML; // æ”¹ç”¨ .innerHTML
  
  // å»ºç«‹é¸é … (å–®å­—)
  const allChoices = [q.answer, ...q.distractors];
  const choices = shuffle(allChoices);

  choices.forEach((choice) => {
    const btn = document.createElement("button");
    btn.innerText = choice; // é¸é …æ˜¯è‹±æ–‡å–®å­—
    btn.onclick = () => handleSentenceChoice(btn, choice);
    container.appendChild(btn);
  });
}

function handleSentenceChoice(button, choice) {
  const q = questionSet[currentIndex]; // âœ… å–å¾—å®Œæ•´é¡Œç›®ç‰©ä»¶
  const correctAnswer = q.answer;
  const sentence = q.sentence;
  const translation = q.chinese || ""; // âœ… å–å¾—ä¸­æ–‡ç¿»è­¯
  attempts++;

  if (choice === correctAnswer) {
    button.classList.add("correct");
    document.querySelectorAll(".options button").forEach(btn => btn.disabled = true);
    
    // âœ… çµ„åˆå®Œæ•´å¥å­ï¼Œä¸¦å°‡ç­”æ¡ˆåŠ ç²—
    const fullSentence = sentence.replace("________", `<strong>${correctAnswer}</strong>`);

    if (currentIndex === 0 && !document.getElementById("result-title").innerText) {
      document.getElementById("result-title").innerText = `${window.username} çš„æŒ‘æˆ°çµæœï¼š`;
    }
    
    // âœ… æ›´æ–°çµæœç´€éŒ„ (Log)
    const logEntry = (attempts === 1
        ? `<li>âœ… ${fullSentence} â€” ${attempts} æ¬¡ â€” +5åˆ†`
        : `<li style="color: #facc15;">ğŸŸ¡ ${fullSentence} â€” ${attempts} æ¬¡ â€” 0åˆ†`);
    
    // âœ… 2025/11/11 ç­”é¡Œç´€éŒ„æ”¹ç‚ºé¡¯ç¤ºåœ¨æœ€ä¸Šæ–¹
    // âœ… å°‡ç¿»è­¯åŠ åœ¨ä¸‹ä¸€è¡Œ (ä¸¦ç§»åˆ°æœ€ä¸Šé¢)
    document.getElementById("results").innerHTML = `${logEntry}<br><small style="color: var(--text-muted); padding-left: 20px;">${translation}</small></li>` + document.getElementById("results").innerHTML;

    if (attempts === 1) {
      score += 5;
    }
    updateScoreDisplay();

    // âœ… èªéŸ³ä¿®æ­£ï¼šä½¿ç”¨ callback
    const sentenceToSpeak = sentence.replace("________", correctAnswer); // å¿µå‡ºå®Œæ•´çš„å¥å­

    const nextStep = () => {
      currentIndex++;
      const quizCompleted = typeof totalQuestionsToComplete === 'number' 
                          ? currentIndex >= totalQuestionsToComplete 
                          : currentIndex >= questionSet.length;

      if (!quizCompleted && wrongCount < 3) {
        renderQuestion(); // å‘¼å«ä¸»è·¯ç”±å™¨
      } else {
        endGame();
      }
    };
    
    speak(sentenceToSpeak, nextStep); // æ’­æ”¾å®Œå¥å­å¾Œï¼Œæ‰åŸ·è¡Œ nextStep

  } else {
    button.classList.add("incorrect");
    button.disabled = true;
    wrongCount++;
    lives = 3 - wrongCount;
    updateLivesDisplay();
    
    // âœ… ã€ä¿®æ­£ã€‘é‚„åŸï¼šç­”éŒ¯æ™‚ï¼ˆéæœ€å¾Œä¸€æ¢å‘½ï¼‰ä¸é¡¯ç¤º Log
    /*
    if (lives > 0) {
      ...
    }
    */

    if (lives <= 0) {
      // âœ… èªéŸ³ä¿®æ­£ï¼šç­”éŒ¯æœ€å¾Œä¸€æ¢å‘½
      const fullSentence = sentence.replace("________", `<strong>${correctAnswer}</strong>`);
      const sentenceToSpeak = sentence.replace("________", correctAnswer);
      const translation = q.chinese || ""; // âœ… ç¢ºä¿çµæŸæ™‚ä¹Ÿèƒ½æŠ“åˆ°ç¿»è­¯

      // âœ… åœ¨çµæŸå‰ï¼Œè£œä¸Šæœ€å¾Œä¸€é¡Œçš„æ­£ç¢ºç­”æ¡ˆLog
      // âœ… 2025/11/11 ç­”é¡Œç´€éŒ„æ”¹ç‚ºé¡¯ç¤ºåœ¨æœ€ä¸Šæ–¹
      document.getElementById("results").innerHTML = 
        `<li style="color: var(--danger);">âŒ ${fullSentence} (æ­£ç¢ºç­”æ¡ˆ)<br><small style="color: var(--text-muted); padding-left: 20px;">${translation}</small></li>` + document.getElementById("results").innerHTML;
      
      speak(`Correct answer: ${sentenceToSpeak}`, endGame); // å¿µå®Œæ­£ç¢ºç­”æ¡ˆå¾Œï¼Œæ‰çµæŸéŠæˆ²
    }
  }
}

// ===============================================
// æ ¸å¿ƒéŠæˆ²é‚è¼¯ (Router)
// ===============================================

// âœ… æ–°å¢ï¼šæ ¹æ“š quizType æ›´æ–° UI é¡¯ç¤º
function updateUIForQuizType(quizType) {
  const title = document.getElementById("main-title");
  const subtitle = document.getElementById("main-subtitle");
  // const hint = document.getElementById("main-hint"); // âœ… ç§»é™¤
  
  if (quizType === "vocab") {
    title.innerHTML = "GEPT Vocabulary Battle âš¡";
    subtitle.innerHTML = "è½ç™¼éŸ³ã€é¸ä¸­æ–‡ï¼Œçœ‹çœ‹ä½ èƒ½å®ˆä½å¹¾æ¢å‘½ï¼";
    // hint.innerHTML = "å°æç¤ºï¼šé–‹å§‹å¾ŒæŒ‰éˆ•å¯é‡è½ç™¼éŸ³ ğŸ§"; // âœ… ç§»é™¤
  } else if (quizType === "sentence") {
    title.innerHTML = "GEPT Sentence Challenge âœï¸";
    subtitle.innerHTML = "é–±è®€å¥å­ã€é¸å‡ºæ­£ç¢ºå–®å­—ï¼Œå®Œæˆå¡«ç©ºï¼";
    // hint.innerHTML = "å°æç¤ºï¼šé–‹å§‹å¾ŒæŒ‰éˆ•å¯é‡è½ã€Œé¡Œç›®ã€ç™¼éŸ³ ğŸ§"; // âœ… ç§»é™¤
  }
  
  // âœ… ä¿®æ­£ï¼š
  // æ­¤å‡½æ•¸åªåœ¨ "è¼‰å…¥" æˆ– "åˆ‡æ›é¡Œåº«" æ™‚å‘¼å«
  // æˆ‘å€‘è¦ç¢ºä¿æŒ‰éˆ•åœ¨éŠæˆ²æœªé–‹å§‹æ™‚ï¼Œé¡¯ç¤ºæ­£ç¢ºçš„æ–‡å­—èˆ‡åŠŸèƒ½
  const startButton = document.getElementById("start-btn");
  const quizInProgress = document.querySelector(".quiz").style.display === "block";
  
  if (!quizInProgress) {
      startButton.innerHTML = "é–‹å§‹æŒ‘æˆ°";
      startButton.onclick = startQuiz;
  }
}

// âœ… æ•´åˆï¼šä¸»æ¸²æŸ“å‡½æ•¸ (Router)
function renderQuestion() {
  // ä¿®æ­£æ‰‹æ©Ÿï¼ˆSafari / Chromeï¼‰æŒ‰éˆ•æ¨£å¼æ®˜ç•™å•é¡Œ
  const container = document.getElementById("options");
  if (container) {
    const oldButtons = container.querySelectorAll("button");
    oldButtons.forEach(btn => {
      btn.classList.remove("correct", "incorrect");
      btn.disabled = false;
      btn.style.background = "";
      btn.style.color = "";
      btn.style.boxShadow = "";
    });
    // ğŸ©µ å¼·åˆ¶è§¸ç™¼é‡ç¹ª
    container.style.display = "none";
    container.offsetHeight; // è§¸ç™¼é‡ç¹ª
    container.style.display = "grid"; // æ¢å¾© (grid)
  }
  
  // æ ¹æ“šæ¨¡å¼å‘¼å«ä¸åŒçš„æ¸²æŸ“å‡½æ•¸
  if (currentQuizType === "vocab") {
    renderVocabQuestion();
  } else {
    renderSentenceQuestion();
  }
}

// âœ… æ•´åˆï¼š"é‡è½" æŒ‰éˆ•çš„å‡½æ•¸ (Router)
function speakCurrent() {
  if (currentQuizType === "vocab") {
    const currentWord = questionSet[currentIndex].Vocabulary;
    speak(currentWord); // (ä¸éœ€ callback)
  } else {
    let currentSentence = questionSet[currentIndex].sentence;
    // âœ… ä¿®æ­£ï¼šå°‡åº•ç·šæ›æˆ"..."ï¼ŒèªéŸ³æœƒåœ¨é€™è£¡åœé “
    const sentenceToSpeak = currentSentence.replace("________", "..."); 
    speak(sentenceToSpeak); // (ä¸éœ€ callback)
  }
}

function startQuiz() {
  console.log("startQuiz å‡½æ•¸å·²è§¸ç™¼");
  const name = document.getElementById("username").value.trim();
  if (!name) {
    alert("è«‹è¼¸å…¥åå­—ï¼");
    return;
  }

  // æ•´åˆï¼šåœ¨é–‹å§‹æ™‚æ±ºå®šæ¨¡å¼
  const selected = document.getElementById("dataset").options[document.getElementById("dataset").selectedIndex];
  currentQuizType = selected.getAttribute("data-quiz-type") || "vocab";
  
  // âœ… ä¿®æ­£ï¼š(Request 2 & 3) æ˜ç¢ºè¨­å®šæŒ‰éˆ•æ–‡å­—å’ŒåŠŸèƒ½
  const startButton = document.getElementById("start-btn");
  if (currentQuizType === "vocab") {
    startButton.innerHTML = "ğŸ”Š é‡è½ç™¼éŸ³";
  } else {
    startButton.innerHTML = "ğŸ”Š å¥å­ç™¼éŸ³"; // ä¿®æ­£æ–‡å­—
  }
  startButton.onclick = speakCurrent; // ç¶å®šæ•´åˆå¾Œçš„é‡è½å‡½æ•¸

  // âœ… ä¿®æ­£ï¼šéš±è—æ–°çš„ username-row
  const usernameRow = document.getElementById("username-row");
  if (usernameRow) {
    usernameRow.style.display = "none";
  }

  document.getElementById("progress-section").style.display = "block";
  document.querySelector(".quiz").style.display = "block";
  window.username = name;
  lives = 3;

  if (!questionSet.length) {
    console.error("é¡Œåº«æœªåˆå§‹åŒ–ï¼Œå˜—è©¦ä½¿ç”¨é è¨­é¡Œåº«");
    questionSet = shuffle([...defaultData]);
  }

  try {
    fetchLeaderboard();
  } catch (err) {
    console.warn("æ’è¡Œæ¦œè¼‰å…¥å¤±æ•—ï¼Œç¹¼çºŒåŸ·è¡ŒéŠæˆ²");
  }

  renderQuestion(); // å‘¼å«ä¸»è·¯ç”±å™¨
}

// ===============================================
// åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½
// ===============================================

document.addEventListener("keydown", function(event) {
  if (event.key === "Enter") {
    const input = document.getElementById("username");
    // âœ… ä¿®æ­£ï¼šæª¢æŸ¥ input çš„çˆ¶å±¤ row æ˜¯å¦å¯è¦‹
    const usernameRow = document.getElementById("username-row");
    if (usernameRow && window.getComputedStyle(usernameRow).display !== "none") {
      startQuiz();
    }
  }
});

document.getElementById("dataset").addEventListener("change", async function(e) {
  
  // âœ… æ–°å¢ï¼šé˜²å‘†ç¢ºèª
  const quizInProgress = document.querySelector(".quiz").style.display === "block";
  if (quizInProgress) {
    const confirmed = confirm("æŒ‘æˆ°å°šæœªå®Œæˆï¼Œç¢ºå®šè¦åˆ‡æ›é¡Œåº«å—ï¼Ÿ\nï¼ˆç›®å‰çš„é€²åº¦å°‡æœƒéºå¤±ï¼‰");
    if (!confirmed) {
      e.target.value = currentDatasetFile; // å°‡ <select> é‡è¨­å›ä¸Šä¸€å€‹è¼‰å…¥çš„æª”æ¡ˆ
      return; // ä¸­æ–·åŸ·è¡Œ
    }
  }
  
  // ----- å¦‚æœç¢ºèªåˆ‡æ›ï¼Œæˆ–éŠæˆ²æœªé–‹å§‹ï¼Œæ‰ç¹¼çºŒ -----
  
  const file = e.target.value;
  const selected = e.target.options[e.target.selectedIndex];
  const limit = selected.getAttribute("data-limit");
  
  // æ•´åˆï¼šæ›´æ–°æ¨¡å¼
  currentQuizType = selected.getAttribute("data-quiz-type") || "vocab";
  updateUIForQuizType(currentQuizType); // åˆ‡æ›é¡Œåº«æ™‚ç«‹åˆ»æ›´æ–° UI

  totalQuestionsToComplete = limit === "all" ? "all" : parseInt(limit);

  try {
    const res = await fetch(file);
    if (!res.ok) {
      throw new Error(`HTTP éŒ¯èª¤ï¼Œç‹€æ…‹ç¢¼ï¼š${res.status}`);
    }
    data = await res.json();
    currentDatasetFile = file; // âœ… æˆåŠŸè¼‰å…¥å¾Œï¼Œæ›´æ–°ç›®å‰æª”æ¡ˆ
    questionSet = shuffle([...data]);
    currentIndex = 0;
    wrongCount = 0;
    score = 0;
    lives = 3;
    updateProgressBar();
    updateScoreDisplay();
    updateLivesDisplay();
    if (document.querySelector(".quiz").style.display === "block") {
      // å¦‚æœéŠæˆ²å·²åœ¨é€²è¡Œä¸­ï¼Œåˆ‡æ›å¾Œç›´æ¥é–‹å§‹æ–°éŠæˆ²
      document.getElementById("results").innerHTML = "";
      document.getElementById("result-title").innerText = "";
      renderQuestion(); // å‘¼å«ä¸»è·¯ç”±å™¨
    }
  } catch (err) {
    console.warn("è¼‰å…¥é¡Œåº«å¤±æ•—ï¼Œä½¿ç”¨é è¨­é¡Œåº«");
    // âœ… ä¿®æ­£ï¼šç¢ºä¿é è¨­é¡Œåº«èˆ‡ currentQuizType ä¸€è‡´
    if (currentQuizType === 'sentence') {
        data = [{ "sentence": "Default ________.", "answer": "question", "distractors": ["a", "b", "c"], "chinese": "é è¨­å•é¡Œã€‚" }];
    } else {
        data = [{ Vocabulary: "error", Chinese: "éŒ¯èª¤" }];
    }
    
    currentDatasetFile = document.getElementById("dataset").options[0].value; // âœ… è¼‰å…¥å¤±æ•—ï¼Œé‡è¨­ç‚ºé è¨­æª”æ¡ˆ
    questionSet = shuffle([...data]);
    currentIndex = 0;
    wrongCount = 0;
    score = 0;
    lives = 3;
    updateProgressBar();
    updateScoreDisplay();
    updateLivesDisplay();
    if (document.querySelector(".quiz").style.display === "block") {
      document.getElementById("results").innerHTML = "";
      document.getElementById("result-title").innerText = "";
      renderQuestion(); // å‘¼å«ä¸»è·¯ç”±å™¨
    }
  }
});

/* ä¸»é¡Œåˆ‡æ›ï¼šæš—è‰² / äº®è‰² + localStorage è¨˜æ†¶ */
const THEME_STORAGE_KEY = "gept_theme";
const themeToggleBtn = document.getElementById("theme-toggle");

function applyTheme(theme) {
  if (theme === "light") {
    document.body.classList.add("light-mode");
    if (themeToggleBtn) {
      themeToggleBtn.querySelector(".icon").textContent = "â˜€ï¸";
      themeToggleBtn.querySelector(".label").textContent = "äº®è‰²æ¨¡å¼";
    }
  } else {
    document.body.classList.remove("light-mode");
    if (themeToggleBtn) {
      themeToggleBtn.querySelector(".icon").textContent = "ğŸŒ™";
      themeToggleBtn.querySelector(".label").textContent = "æš—è‰²æ¨¡å¼";
    }
  }
}

const storedTheme = localStorage.getItem(THEME_STORAGE_KEY) || "dark";
applyTheme(storedTheme);

if (themeToggleBtn) {
  themeToggleBtn.addEventListener("click", () => {
    const newTheme = document.body.classList.contains("light-mode") ? "dark" : "light";
    localStorage.setItem(THEME_STORAGE_KEY, newTheme);
    applyTheme(newTheme);
  });
}

(async () => {
  console.log("é é¢åˆå§‹åŒ–é–‹å§‹");
  const file = document.getElementById("dataset").value;
  const selected = document.getElementById("dataset").options[document.getElementById("dataset").selectedIndex];
  const limit = selected.getAttribute("data-limit");

  currentDatasetFile = file; // âœ… å„²å­˜åˆå§‹è¼‰å…¥çš„æª”æ¡ˆ

  // æ•´åˆï¼šåˆå§‹åŒ–æ™‚è¨­å®šæ¨¡å¼
  currentQuizType = selected.getAttribute("data-quiz-type") || "vocab";
  updateUIForQuizType(currentQuizType); // æ›´æ–° UI

  totalQuestionsToComplete = limit === "all" ? "all" : parseInt(limit);
  try {
    const res = await fetch(file);
    if (!res.ok) {
      throw new Error(`HTTP éŒ¯èª¤ï¼Œç‹€æ…‹ç¢¼ï¼š${res.status}`);
    }
    data = await res.json();
  } catch (err) {
    console.warn("åˆå§‹é¡Œåº«è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­é¡Œåº«");
    // âœ… ä¿®æ­£ï¼šç¢ºä¿é è¨­é¡Œåº«èˆ‡ currentQuizType ä¸€è‡´
    if (currentQuizType === 'sentence') {
        data = [{ "sentence": "Default ________.", "answer": "question", "distractors": ["a", "b", "c"], "chinese": "é è¨­å•é¡Œã€‚" }];
    } else {
        data = [{ Vocabulary: "error", Chinese: "éŒ¯èª¤" }];
    }
  }
  
  // å¦‚æœè¼‰å…¥çš„è³‡æ–™æ˜¯ç©ºçš„ (ä¾‹å¦‚ JSON æª”å…§å®¹ç‚º [])ï¼Œä¹Ÿä½¿ç”¨é è¨­é¡Œåº«
  if (!Array.isArray(data) || data.length === 0) {
      console.warn("é¡Œåº«ç‚ºç©ºï¼Œä½¿ç”¨é è¨­é¡Œåº«");
      if (currentQuizType === 'sentence') {
          data = [{ "sentence": "Default ________.", "answer": "question", "distractors": ["a", "b", "c"], "chinese": "é è¨­å•é¡Œã€‚" }];
      } else {
          data = [{ Vocabulary: "error", Chinese: "éŒ¯èª¤" }];
      }
  }
  
  questionSet = shuffle([...data]);
  currentIndex = 0;
  wrongCount = 0;
  score = 0;
  lives = 3;
  updateProgressBar();
  updateScoreDisplay();
  updateLivesDisplay();
  try {
    fetchLeaderboard();
  } catch (err) {
    console.warn("åˆå§‹æ’è¡Œæ¦œè¼‰å…¥å¤±æ•—");
  }
  
  console.log("é é¢åˆå§‹åŒ–å®Œæˆ");
})();
  </script>
</body>
</html>
