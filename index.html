<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GEPT Vocabulary Quiz</title>
  <style>
    :root {
      --main-bg: #f7f9fc;
      --card-bg: #ffffff;
      --accent: #0072ff;
      --accent-light: #a0c8ff;
      --text-dark: #1e1e1e;
      --text-light: #555;
      --shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      --radius: 14px;
      --transition: all 0.25s ease;
    }

    body {
      font-family: 'Segoe UI', 'Noto Sans TC', system-ui, sans-serif;
      background: var(--main-bg);
      color: var(--text-dark);
      margin: 0 auto;
      padding: 30px;
      max-width: 780px;
      line-height: 1.6;
      transition: background 0.4s, color 0.4s;
    }

    h1 {
      text-align: center;
      font-size: 2.2em;
      color: var(--accent);
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    select, input, button {
      font-family: inherit;
      transition: var(--transition);
    }

    select, input {
      padding: 10px 14px;
      border-radius: var(--radius);
      border: 1px solid #ccc;
      background: var(--card-bg);
      box-shadow: var(--shadow);
    }

    button {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      padding: 10px 18px;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(0, 114, 255, 0.2);
      transition: var(--transition);
    }

    button:hover {
      background: #0056d6;
    }

    .progress-container {
      height: 10px;
      background: #e1e6ef;
      border-radius: 9999px;
      margin: 25px 0;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #00c6ff, #0072ff);
      transition: width 0.3s ease-in-out;
    }

    .quiz {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 24px 28px;
      box-shadow: var(--shadow);
      margin-top: 30px;
    }

    .question {
      font-size: 1.6em;
      text-align: center;
      color: var(--text-dark);
      margin-bottom: 1.5em;
    }

    .options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .options button {
      font-weight: 600;
      font-size: 1.1em;
      background: #f0f3f8;
      border-radius: var(--radius);
      border: none;
      padding: 16px;
      box-shadow: inset 0 0 0 2px transparent;
    }

    .options button:hover {
      background: #e6ecf5;
      transform: translateY(-1px);
    }

    .options button.correct {
      background: #e8fbee;
      color: #155724;
      box-shadow: inset 0 0 0 2px #2ecc71;
    }

    .options button.incorrect {
      background: #fbeaea;
      color: #721c24;
      box-shadow: inset 0 0 0 2px #e57373;
    }

    .score-display {
      font-weight: 600;
      text-align: center;
      color: var(--text-dark);
      margin-bottom: 8px;
    }

    .lives-display {
      text-align: center;
      color: #e63946;
      font-weight: 500;
      margin-bottom: 20px;
      font-size: 1.3em;
    }

    .leaderboard {
      margin-top: 40px;
      background: var(--card-bg);
      padding: 22px 28px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .leaderboard h2 {
      text-align: center;
      color: var(--accent);
      margin-bottom: 10px;
    }

    .leaderboard button {
      padding: 8px 14px;
      margin: 4px;
      border-radius: 8px;
      font-size: 0.95em;
      border: none;
      color: #fff;
      cursor: pointer;
    }

    #expand-all { background: #007bff; }
    #collapse-all { background: #6c757d; }

    details {
      margin-top: 14px;
      background: #fafbff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px 16px;
    }

    summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--accent);
      font-size: 1.05em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    summary:hover {
      color: #0056d6;
    }

    .result-log {
      margin-top: 20px;
      padding-left: 0;
      list-style: none;
    }

    .result-log li {
      padding: 6px 0;
      font-size: 0.95em;
      color: var(--text-light);
      border-bottom: 1px solid #eee;
    }

    .badges {
      text-align: center;
      margin-top: 20px;
    }

    .badges span {
      display: inline-block;
      padding: 8px 14px;
      margin: 4px;
      background: linear-gradient(90deg, #ffe680, #ffd24d);
      color: #333;
      border-radius: 20px;
      font-size: 0.9em;
      box-shadow: var(--shadow);
    }

    footer {
      text-align: center;
      color: #aaa;
      margin-top: 50px;
      font-size: 0.85em;
    }

    /* === å¤œé–“æ¨¡å¼ === */
    body.dark {
      --main-bg: #0e1217;
      --card-bg: #1a1f25;
      --accent: #66b2ff;
      --accent-light: #99ccff;
      --text-dark: #e5e9f0;
      --text-light: #b0b8c1;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
    }

    body.dark button {
      box-shadow: 0 3px 10px rgba(102,178,255,0.2);
    }

    body.dark .options button {
      background: #232a33;
      color: var(--text-dark);
    }

    body.dark .options button:hover {
      background: #2a323c;
    }

    body.dark .leaderboard {
      background: #1d232b;
    }

    body.dark details {
      background: #232a33;
    }

    body.dark #theme-toggle {
      background: #232a33;
      color: #fff;
    }

    /* Loading Spinner */
    #loading-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(4px);
      z-index: 200;
      justify-content: center;
      align-items: center;
      font-size: 1.2em;
      color: var(--accent);
    }
    body.dark #loading-overlay {
      background: rgba(0,0,0,0.6);
      color: #99ccff;
    }
    .spinner {
      border: 4px solid #e1e6ef;
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- å¤œé–“æ¨¡å¼åˆ‡æ› -->
  <button id="theme-toggle" style="
    position: fixed;
    top: 18px;
    right: 22px;
    z-index: 100;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 1.2em;
    cursor: pointer;
    background: var(--card-bg);
    color: var(--text-dark);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  ">ğŸŒ™</button>

  <!-- Loading Overlay -->
  <div id="loading-overlay">
    <div class="spinner"></div> è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™â€¦
  </div>

  <h1>GEPTåˆç´š å–®å­—æŒ‘æˆ°</h1>
  
  <div style="text-align: center; margin-top: 10px;">
    <label for="dataset">é¡Œåº«é¸æ“‡ï¼š</label>
  <select id="dataset" style="padding: 6px 10px; font-size: 1em;">
    <option value="GEPT_20251109.json" data-limit="all">ğŸŒ GEPT ç¬¬ä¸‰å›+ç¬¬å››å›</option>
    <option value="week1.json" data-limit="all">ğŸŸ¡ Week 1 (ä¸»é¡Œèª²æ–‡25é¡Œ)</option>
    <option value="week2.json" data-limit="all">ğŸŸ¡ Week 2 (ä¸»é¡Œèª²æ–‡30é¡Œ)</option>
    <option value="week2-bonus.json" data-limit="25">âœ¨ Week 2 (æ“´å……æŒ‘æˆ°25/50)</option>
    <option value="GEPT_Stage3.json" data-limit="50">ğŸ¤© æ“´å……æŒ‘æˆ°Lv.3 (50/50)</option>
    <option value="GEPT_Week3_Vocab.json" data-limit="all">ğŸ¤© æ“´å……æŒ‘æˆ°Lv.3</option>
    <option value="gept-full.json" data-limit="25">ğŸ”µ å…¨ GEPT (éš¨æ©ŸæŒ‘æˆ°25/2256)</option>
    <option value="gept-full.json" data-limit="all">ğŸ”µ å…¨ GEPT (é­”é¬¼æŒ‘æˆ°2256é¡Œ)</option>
  </select>  </div>
  <div style="text-align: center; margin-top: 20px;">
    <label for="username">è«‹è¼¸å…¥ä½ çš„åå­—ï¼š</label>
    <input id="username" type="text" placeholder="ä¾‹å¦‚ï¼šEmmett" style="padding: 8px 12px; font-size: 1em; border-radius: 8px; border: 1px solid #ccc; margin-top: 8px;" />
    <button id="start-btn" onclick="startQuiz()" style="margin-left: 10px; padding: 8px 16px; font-size: 1em; border-radius: 8px; background-color: #007bff; color: white; border: none; cursor: pointer;">é–‹å§‹æŒ‘æˆ°</button>
  </div>

  <div class="progress-container" style="display:none;" id="progress-section">
    <div class="progress-bar" id="progress-bar"></div>
  </div>
  <div class="quiz" style="display:none;">
    <div class="score-display" id="score-display">ç›®å‰å¾—åˆ†ï¼š0</div>
    <div class="lives-display" id="lives-display">å‰©é¤˜ç”Ÿå‘½ï¼šâ¤ï¸â¤ï¸â¤ï¸</div>
    <div class="question" id="question"></div>
    <div class="options" id="options"></div>
    <h3 id="result-title" style="margin-top:30px;"></h3>
    <ul class="result-log" id="results"></ul>
    <div class="badges" id="badges"></div>
  </div>

  <div class="leaderboard" id="leaderboard">
    <h2>ğŸ† ç©åˆ†æ’è¡Œæ¦œ</h2>
    <ul id="leaderboard-list"></ul>
  </div>

  <script>
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyg8OvuiCZbrtUTBy6a1pKyWeGUZJJbCJsxeodvwgbs9I2o6Fe7dS_irIntu44SNmJrig/exec"; // å·²æ›¿æ›ç‚º Google Apps Script Web App URL

let selectedVoice = null;
let badgesEarned = JSON.parse(localStorage.getItem("badges")) || [];

function findEnglishVoice() {
  const voices = speechSynthesis.getVoices();
  const priority = ['Google US English', 'Samantha', 'Microsoft Aria Online (Natural) - English (United States)', 'Microsoft Zira', 'Microsoft David', 'Karen', 'Alex'];
  for (const name of priority) {
    const match = voices.find(v => v.name.includes(name));
    if (match) return match;
  }
  return voices.find(v => v.lang === 'en-US') || voices[0];
}

speechSynthesis.onvoiceschanged = () => {
  selectedVoice = findEnglishVoice();
};

let data = [
  { Vocabulary: "breathe fire", Chinese: "å™´ç«" },
  { Vocabulary: "trainer", Chinese: "è¨“ç·´å¸«" },
  { Vocabulary: "journey", Chinese: "æ—…ç¨‹ / ä¸€æ®µè·¯" },
  { Vocabulary: "rare", Chinese: "ç¨€æœ‰çš„" },
  { Vocabulary: "care", Chinese: "ç…§é¡§" },
  { Vocabulary: "decide", Chinese: "æ±ºå®š" },
  { Vocabulary: "pick", Chinese: "æŒ‘é¸" },
  { Vocabulary: "lab", Chinese: "å¯¦é©—å®¤" },
  { Vocabulary: "each", Chinese: "æ¯å€‹äºº" },
  { Vocabulary: "fluffy", Chinese: "æ¯›çµ¨çµ¨çš„" },
  { Vocabulary: "energetic", Chinese: "æœ‰æ´»åŠ›çš„" },
  { Vocabulary: "nod", Chinese: "é»é ­" },
  { Vocabulary: "electric", Chinese: "é›»çš„" },
  { Vocabulary: "icy", Chinese: "çµå‡çš„" },
  { Vocabulary: "punch", Chinese: "æ" },
  { Vocabulary: "wings", Chinese: "ç¿…è†€" },
  { Vocabulary: "horns", Chinese: "è§’" },
  { Vocabulary: "tail", Chinese: "å°¾å·´" },
  { Vocabulary: "furry", Chinese: "æœ‰æ¯›çš„" },
  { Vocabulary: "striped", Chinese: "æœ‰æ¢ç´‹çš„" },
  { Vocabulary: "claw", Chinese: "çˆªå­" },
  { Vocabulary: "library", Chinese: "åœ–æ›¸é¤¨" },
  { Vocabulary: "museum", Chinese: "åšç‰©é¤¨" },
  { Vocabulary: "backpack", Chinese: "èƒŒåŒ…" },
  { Vocabulary: "breakfast", Chinese: "æ—©é¤" },
  { Vocabulary: "hungry", Chinese: "è‚šå­é¤“çš„" },
  { Vocabulary: "dentist", Chinese: "ç‰™é†«" },
  { Vocabulary: "stationary", Chinese: "æ–‡å…·" },
  { Vocabulary: "friendly", Chinese: "å‹å–„çš„" },
  { Vocabulary: "exercise", Chinese: "é‹å‹•" },
  { Vocabulary: "science", Chinese: "ç§‘å­¸" },
  { Vocabulary: "noisy", Chinese: "åµçš„" },
  { Vocabulary: "brave", Chinese: "å‹‡æ•¢çš„" },
  { Vocabulary: "careful", Chinese: "å°å¿ƒçš„" },
  { Vocabulary: "weekend", Chinese: "é€±æœ«" }
];

let defaultData = [...data];
let questionSet = [];
let currentIndex = 0;
let attempts = 0;
let wrongCount = 0;
let totalQuestionsToComplete = "all"; // é è¨­ç‚ºå…¨éƒ¨å•é¡Œ
let score = 0;
let lives = 3;
let gameSession = Date.now();

function shuffle(array) {
  return array.sort(() => Math.random() - 0.5);
}

function updateProgressBar() {
  // å¦‚æœæ˜¯æ•¸å­—é™åˆ¶ï¼Œå‰‡ä»¥è©²é™åˆ¶ç‚ºæº–ï¼›å¦å‰‡ä»¥å…¨éƒ¨å•é¡Œæ•¸é‡ç‚ºæº–
  const totalQuestions = typeof totalQuestionsToComplete === 'number' ? 
                       totalQuestionsToComplete : questionSet.length;
  const percent = (currentIndex / totalQuestions) * 100;
  document.getElementById("progress-bar").style.width = `${percent}%`;
}

function updateScoreDisplay() {
  document.getElementById("score-display").innerText = `ç›®å‰å¾—åˆ†ï¼š${score}`;
}

function updateLivesDisplay() {
  const hearts = 'â¤ï¸'.repeat(lives);
  document.getElementById("lives-display").innerText = `å‰©é¤˜ç”Ÿå‘½ï¼š${hearts}`;
}

function awardBadges() {
  const newBadges = [];
  if (score >= 25) newBadges.push("ğŸ–ï¸ é«˜åˆ†é”äºº");
  if (wrongCount === 0 && currentIndex === questionSet.length) newBadges.push("â­ å®Œç¾æŒ‘æˆ°");
  if (!badgesEarned.includes("ğŸ‰ é¦–æ¬¡æŒ‘æˆ°")) newBadges.push("ğŸ‰ é¦–æ¬¡æŒ‘æˆ°");

  newBadges.forEach(badge => {
    if (!badgesEarned.includes(badge)) badgesEarned.push(badge);
  });

  localStorage.setItem("badges", JSON.stringify(badgesEarned));
  displayBadges();
}

function displayBadges() {
  const badgesContainer = document.getElementById("badges");
  badgesContainer.innerHTML = badgesEarned.length ? badgesEarned.map(badge => `<span>${badge}</span>`).join("") : "å°šæœªç²å¾—å¾½ç« ";
}

async function submitScore() {
  if (!GOOGLE_SCRIPT_URL.includes("YOUR")) {
    try {
      const response = await fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username: window.username,
          score: score,
          session: gameSession,
          dataset: document.getElementById("dataset").options[document.getElementById("dataset").selectedIndex].text
        })
      });

      console.log("åˆ†æ•¸å·²æäº¤è‡³ Google Sheets");
    } catch (err) {
      console.error("æäº¤åˆ†æ•¸å¤±æ•—:", err);
    }
  } else {
    console.warn("æœªè¨­ç½® GOOGLE_SCRIPT_URLï¼Œåˆ†æ•¸æœªæäº¤");
  }
}

async functionboard() {
  if (!GOOGLE_SCRIPT_URL.includes("YOUR")) {
    try {
      const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getLeaderboard`);
      const leaderboard = await response.json();

      // ä¾é¡Œåº«åç¨±åˆ†çµ„
      const grouped = {};
      leaderboard.forEach(entry => {
        const key = entry.dataset || "æœªçŸ¥é¡Œåº«";
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(entry);
      });

      // æ¯çµ„å…§ä¾åˆ†æ•¸æ’åºï¼ˆé«˜â†’ä½ï¼‰ï¼ŒåŒåˆ†ä»¥æ™‚é–“ï¼ˆæ–°â†’èˆŠï¼‰
      for (const key in grouped) {
        grouped[key].sort((a, b) => {
          if (b.score === a.score) {
            return new Date(b.timestamp) - new Date(a.timestamp);
          }
          return b.score - a.score;
        });
        grouped[key] = grouped[key].slice(0, 10);
      }

      // ä¾å„é¡Œåº«æœ€æ–°ç´€éŒ„æ™‚é–“æ’åºï¼ˆæ–°â†’èˆŠï¼‰
      const sortedDatasets = Object.keys(grouped).sort((a, b) => {
        const latestA = Math.max(...grouped[a].map(e => new Date(e.timestamp)));
        const latestB = Math.max(...grouped[b].map(e => new Date(e.timestamp)));
        return latestB - latestA;
      });

      // å–æœ€æ–°å…©å€‹é¡Œåº«é è¨­å±•é–‹
      const expandedDatasets = sortedDatasets.slice(0, 1);

      // ç”Ÿæˆæ’è¡Œæ¦œ HTML
      const leaderboardList = document.getElementById("leaderboard-list");

      // å…ˆæ’å…¥æ§åˆ¶æŒ‰éˆ•
      leaderboardList.innerHTML = `
        <div style="text-align:center; margin:10px 0;">
          <button id="expand-all" style="
            padding:6px 12px; 
            margin-right:8px;
            background:#007bff;
            color:white;
            border:none;
            border-radius:6px;
            cursor:pointer;
          ">å±•é–‹å…¨éƒ¨</button>
          <button id="collapse-all" style="
            padding:6px 12px; 
            background:#6c757d;
            color:white;
            border:none;
            border-radius:6px;
            cursor:pointer;
          ">å…¨éƒ¨æ”¶èµ·</button>
        </div>
      `;

      // åŠ å…¥æ¯å€‹é¡Œåº«
      leaderboardList.innerHTML += sortedDatasets.map(dataset => {
        const entries = grouped[dataset];
        const latestTime = new Date(Math.max(...entries.map(e => new Date(e.timestamp))));
        const isOpen = expandedDatasets.includes(dataset) ? "open" : "";
        return `
          <li style="list-style:none; margin-top:10px;">
            <details ${isOpen} class="dataset-block" style="
              background:#fff; 
              border-radius:8px; 
              box-shadow:0 2px 5px rgba(0,0,0,0.05); 
              padding:10px;">
              <summary style="
                cursor:pointer; 
                font-weight:bold; 
                color:#0072ff; 
                font-size:1.1em;">
                ğŸ“˜ ${dataset}
                <small style="color:#888; font-weight:normal;">ï¼ˆæœ€æ–°æ›´æ–°ï¼š${latestTime.toLocaleString()}ï¼‰</small>
              </summary>
              <ul style="list-style:none; padding:6px 0 0 16px; margin:0;">
                ${entries.map((entry, index) => `
                  <li style="padding:6px 0; display:flex; justify-content:space-between; border-bottom:1px solid #eee;">
                    <span>${index + 1}. ${entry.username}</span>
                    <span>${entry.score}åˆ†ï½œ${new Date(entry.timestamp).toLocaleString()}</span>
                  </li>
                `).join("")}
              </ul>
            </details>
          </li>
        `;
      }).join("");

      // ç¶å®šå±•é–‹ï¼æ”¶èµ·æŒ‰éˆ•äº‹ä»¶
      document.getElementById("expand-all").addEventListener("click", () => {
        document.querySelectorAll(".dataset-block").forEach(el => (el.open = true));
      });
      document.getElementById("collapse-all").addEventListener("click", () => {
        document.querySelectorAll(".dataset-block").forEach(el => (el.open = false));
      });

    } catch (err) {
      console.error("è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:", err);
      document.getElementById("leaderboard-list").innerHTML = "<li>ç„¡æ³•è¼‰å…¥æ’è¡Œæ¦œ</li>";
    }
  } else {
    document.getElementById("leaderboard-list").innerHTML = "<li>è«‹è¨­ç½® Google Sheets é€£çµ</li>";
  }
}



function endGame() {
  updateProgressBar();
  awardBadges();
  submitScore();
  fetchLeaderboard();
  document.querySelector(".quiz").innerHTML = `
    <h2>ğŸ‰ ${window.username}ï¼Œæœ¬æ¬¡æŒ‘æˆ°çµæŸï¼</h2>
    <h3>ç¸½å¾—åˆ†ï¼š${score}</h3>
    <h3 id="result-title" style="margin-top:30px;"></h3>
    <ul class="result-log" id="results">${document.getElementById("results").innerHTML}</ul>
    <div class="badges" id="badges">${document.getElementById("badges").innerHTML}</div>
    <div style="text-align: center; margin-top: 20px;">
      <button onclick="location.reload()" style="
        padding: 12px 24px;
        font-size: 1em;
        border: none;
        border-radius: 30px;
        background: linear-gradient(to right, #ff9f1a, #ffc107);
        color: #333;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 4px 4px 10px rgba(0,0,0,0.1);
      ">ğŸ” å†ç©ä¸€æ¬¡</button>
    </div>`;
}

function renderQuestion() {
  attempts = 0;
  updateProgressBar();
  updateScoreDisplay();
  const q = questionSet[currentIndex];
  document.getElementById("question").innerText = `"${q.Vocabulary}" æ˜¯ä»€éº¼æ„æ€ï¼Ÿ`;
  speechSynthesis.cancel();
  if (!selectedVoice) selectedVoice = findEnglishVoice();
  const utterance = new SpeechSynthesisUtterance(q.Vocabulary);
  utterance.voice = selectedVoice;
  utterance.lang = "en-US";
  utterance.rate = 0.9;
  speechSynthesis.speak(utterance);

  // ä»å®Œæ•´æ•°æ®ä¸­éšæœºé€‰æ‹©å¹²æ‰°é¡¹ï¼Œè€Œä¸ä»…ä»…æ˜¯å½“å‰æ•°æ®é›†
  const allChineseAnswers = data.map(item => item.Chinese);
  const correctAnswer = q.Chinese;
  
  // è¿‡æ»¤æ‰å½“å‰çš„æ­£ç¡®ç­”æ¡ˆ
  const possibleDistractors = allChineseAnswers.filter(chinese => chinese !== correctAnswer);
  
  // éšæœºé€‰æ‹©3ä¸ªå¹²æ‰°é¡¹
  const distractors = shuffle(possibleDistractors).slice(0, 3);

  // ç»„åˆé€‰é¡¹å¹¶éšæœºæ’åº
  const choices = shuffle([correctAnswer, ...distractors]).map(chinese => {
    // ä¸ºæ¯ä¸ªé€‰é¡¹åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿå¯¹è±¡ï¼Œä¸åŸå§‹æ•°æ®ç»“æ„å…¼å®¹
    return { Chinese: chinese };
  });

  const container = document.getElementById("options");
  container.innerHTML = "";

  choices.forEach((choice) => {
    const btn = document.createElement("button");
    btn.innerText = choice.Chinese;
    btn.onclick = () => handleChoice(btn, choice);
    container.appendChild(btn);
  });
}
function handleChoice(button, choice) {
  const correctAnswer = questionSet[currentIndex].Chinese;
  attempts++;

  if (choice.Chinese === correctAnswer) {
    button.classList.add("correct");
    document.querySelectorAll(".options button").forEach(btn => btn.disabled = true);
    if (currentIndex === 0 && !document.getElementById("result-title").innerText) {
      document.getElementById("result-title").innerText = `${window.username} çš„æŒ‘æˆ°çµæœï¼š`;
    }
    document.getElementById("results").innerHTML += 
      (attempts === 1
        ? `<li>âœ… ${questionSet[currentIndex].Vocabulary} â€” ${questionSet[currentIndex].Chinese} â€” ${attempts} æ¬¡ â€” +5åˆ†</li>`
        : `<li style="color: #d39e00;">ğŸŸ¡ ${questionSet[currentIndex].Vocabulary} â€” ${questionSet[currentIndex].Chinese} â€” ${attempts} æ¬¡ â€” 0åˆ†</li>`);
    
    if (attempts === 1) {
      score += 5;
    }
    updateScoreDisplay();

    setTimeout(() => {
      currentIndex++;
// æª¢æŸ¥æ˜¯å¦é”åˆ°å®Œæˆæ¢ä»¶
const quizCompleted = typeof totalQuestionsToComplete === 'number' 
                    ? currentIndex >= totalQuestionsToComplete 
                    : currentIndex >= questionSet.length;

if (!quizCompleted && wrongCount < 3) {
  renderQuestion();
} else {
  endGame();
}
    }, 800);
  } else {
    button.classList.add("incorrect");
    button.disabled = true;
    wrongCount++;
    lives = 3 - wrongCount;
    updateLivesDisplay();
    if (lives <= 0) {
      setTimeout(() => {
        endGame();
      }, 800);
    }
  }
}

function startQuiz() {
  console.log("startQuiz å‡½æ•¸å·²è§¸ç™¼");
  const name = document.getElementById("username").value.trim();
  if (!name) {
    alert("è«‹è¼¸å…¥åå­—ï¼");
    return;
  }
  
  const startButton = document.getElementById("start-btn");
  startButton.innerHTML = "ğŸ”Š é‡è½ç™¼éŸ³";
  startButton.onclick = function() {
    speakCurrentWord();
  };
  
  document.getElementById("username").style.display = "none";
  document.querySelector("label[for='username']").style.display = "none";
  
  document.getElementById("progress-section").style.display = "block";
  document.querySelector(".quiz").style.display = "block";
  window.username = name;
  lives = 3;
  
  if (!questionSet.length) {
    console.error("é¡Œåº«æœªåˆå§‹åŒ–ï¼Œå˜—è©¦ä½¿ç”¨é è¨­é¡Œåº«");
    questionSet = shuffle([...defaultData]);
  }
  
  try {
    fetchLeaderboard();
  } catch (err) {
    console.warn("æ’è¡Œæ¦œè¼‰å…¥å¤±æ•—ï¼Œç¹¼çºŒåŸ·è¡ŒéŠæˆ²");
  }
  
  renderQuestion();
}

function speakCurrentWord() {
  const currentWord = questionSet[currentIndex].Vocabulary;
  speechSynthesis.cancel();
  if (!selectedVoice) selectedVoice = findEnglishVoice();
  const utterance = new SpeechSynthesisUtterance(currentWord);
  utterance.voice = selectedVoice;
  utterance.lang = "en-US";
  utterance.rate = 0.9;
  speechSynthesis.speak(utterance);
}

document.addEventListener("keydown", function(event) {
  if (event.key === "Enter") {
    const input = document.getElementById("username");
    if (input && input.style.display !== "none") {
      startQuiz();
    }
  }
});

document.getElementById("dataset").addEventListener("change", async function(e) {
  const file = e.target.value;
  const selected = e.target.options[e.target.selectedIndex];
  const limit = selected.getAttribute("data-limit");
  
  // è¨­å®šç•¶å‰é¸æ“‡çš„é¡Œåº«çš„é¡Œç›®é™åˆ¶
  totalQuestionsToComplete = limit === "all" ? "all" : parseInt(limit);
  
  try {
    // è®€å–æª”æ¡ˆ...
    const res = await fetch(file);
    if (!res.ok) {
      throw new Error(`HTTP éŒ¯èª¤ï¼Œç‹€æ…‹ç¢¼ï¼š${res.status}`);
    }
    data = await res.json();
    questionSet = shuffle([...data]);
    currentIndex = 0;
    wrongCount = 0;
    score = 0;
    lives = 3;
    updateProgressBar();
    updateScoreDisplay();
    updateLivesDisplay();
    if (document.querySelector(".quiz").style.display === "block") {
      document.getElementById("results").innerHTML = "";
      document.getElementById("result-title").innerText = "";
      renderQuestion();
    }
  } catch (err) {
    console.warn("è¼‰å…¥é¡Œåº«å¤±æ•—ï¼Œä½¿ç”¨é è¨­é¡Œåº«");
    data = [...defaultData];
    questionSet = shuffle([...data]);
    currentIndex = 0;
    wrongCount = 0;
    score = 0;
    lives = 3;
    updateProgressBar();
    updateScoreDisplay();
    updateLivesDisplay();
    if (document.querySelector(".quiz").style.display === "block") {
      document.getElementById("results").innerHTML = "";
      document.getElementById("result-title").innerText = "";
      renderQuestion();
    }
  }
});

(async () => {
  console.log("é é¢åˆå§‹åŒ–é–‹å§‹");
  const file = document.getElementById("dataset").value;
  const selected = document.getElementById("dataset").options[document.getElementById("dataset").selectedIndex];
  const limit = selected.getAttribute("data-limit");
  
  // è¨­å®šåˆå§‹é¡Œåº«çš„é¡Œç›®é™åˆ¶
  totalQuestionsToComplete = limit === "all" ? "all" : parseInt(limit);
  try {
    const res = await fetch(file);
    if (!res.ok) {
      throw new Error(`HTTP éŒ¯èª¤ï¼Œç‹€æ…‹ç¢¼ï¼š${res.status}`);
    }
    data = await res.json();
  } catch (err) {
    console.warn("åˆå§‹é¡Œåº«è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­é¡Œåº«");
    data = [...defaultData];
  }
  questionSet = shuffle([...data]);
  currentIndex = 0;
  wrongCount = 0;
  score = 0;
  lives = 3;
  updateProgressBar();
  updateScoreDisplay();
  updateLivesDisplay();
  try {
    fetchLeaderboard();
  } catch (err) {
    console.warn("åˆå§‹æ’è¡Œæ¦œè¼‰å…¥å¤±æ•—");
  }
  displayBadges();
  console.log("é é¢åˆå§‹åŒ–å®Œæˆ");
})();

  // ğŸŒ™ å¤œé–“æ¨¡å¼åˆ‡æ›èˆ‡è¨˜æ†¶
    (function() {
      const toggleBtn = document.getElementById("theme-toggle");
      const savedTheme = localStorage.getItem("theme") || "light";
      if (savedTheme === "dark") {
        document.body.classList.add("dark");
        toggleBtn.textContent = "â˜€ï¸";
      }
      toggleBtn.addEventListener("click", () => {
        document.body.classList.toggle("dark");
        const isDark = document.body.classList.contains("dark");
        toggleBtn.textContent = isDark ? "â˜€ï¸" : "ğŸŒ™";
        localStorage.setItem("theme", isDark ? "dark" : "light");
      });
    })();

    // ğŸŒ€ æ™ºæ…§ Loading Overlay æ§åˆ¶
    const overlay = document.getElementById("loading-overlay");
    function showLoading() { overlay.style.display = "flex"; }
    function hideLoading() { overlay.style.display = "none"; }

    // æ””æˆª fetchï¼Œåªé‡å°é¡Œåº«æˆ–æ’è¡Œæ¦œé¡¯ç¤º Loading
    const originalFetch = window.fetch;
    window.fetch = async (...args) => {
      const url = args[0];
      const show =
        typeof url === "string" &&
        (url.includes(".json") || url.includes("getLeaderboard"));
      try {
        if (show) showLoading();
        const res = await originalFetch(...args);
        return res;
      } finally {
        if (show) setTimeout(hideLoading, 400);
      }
    };
    
  </script>

  <div style="margin-top: 60px; font-size: 0.9em; color: #aaa; text-align: center;">
    Made by Evelyn YT ï½œÂ© 2025 | 2025/11/9 22:16
  
  </div>
</body>
</html>
