<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GEPT æ™ºèƒ½å‡ºé¡Œå¾Œå° (GitHub é€£å‹•ç‰ˆ) ğŸš€</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0f172a;
      --bg-card: #1e293b;
      --accent: #00e0ff;
      --success: #00ff9d;
      --warning: #f59e0b;
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --border: #334155;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Poppins", "Segoe UI", sans-serif;
      background: var(--bg-dark);
      color: var(--text-main);
      margin: 0;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      background: linear-gradient(to right, var(--accent), var(--success));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 2.2em;
      margin-bottom: 10px;
      font-weight: 800;
    }

    .subtitle {
      text-align: center;
      color: var(--text-muted);
      margin-bottom: 30px;
      font-size: 0.9em;
    }

    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      margin-bottom: 20px;
      position: relative;
    }

    .card-header {
      font-size: 1.1em;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-muted);
      font-size: 0.9em;
    }

    input[type="text"],
    input[type="password"], 
    textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #0f172a;
      color: white;
      font-family: inherit;
      font-size: 1em;
      margin-bottom: 16px;
      transition: border-color 0.2s;
    }
    
    input:focus, textarea:focus {
      border-color: var(--accent);
      outline: none;
    }
    
    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .btn {
      background: linear-gradient(135deg, #00e0ff, #00ff9d);
      color: #0f172a;
      border: none;
      padding: 12px 24px;
      border-radius: 999px;
      font-weight: 700;
      cursor: pointer;
      font-size: 1em;
      transition: transform 0.2s, filter 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
    }

    .btn-github {
      background: linear-gradient(135deg, #6366f1, #a855f7);
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
    }

    .btn:disabled {
      background: #475569;
      color: #94a3b8;
      cursor: not-allowed;
      transform: none;
    }

    .preview-item {
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      display: grid;
      grid-template-columns: 40px 1fr;
      gap: 16px;
      align-items: start;
    }

    .preview-input {
      width: 100%;
      background: transparent;
      border: 1px solid #334155;
      color: #e2e8f0;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 0.9em;
      margin-bottom: 8px;
    }

    #loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: var(--accent);
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(0, 224, 255, 0.3);
      border-top-color: #00e0ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 10px;
    }
    
    .status-msg {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      display: none;
      font-size: 0.9em;
    }
    .status-success { background: rgba(0, 255, 157, 0.2); color: #00ff9d; border: 1px solid #00ff9d; }
    .status-error { background: rgba(255, 56, 96, 0.2); color: #ff3860; border: 1px solid #ff3860; }

    .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ¤– GEPT å…¨è‡ªå‹•å‡ºé¡Œå¾Œå°</h1>
  <div class="subtitle">AI å‡ºé¡Œ + GitHub è‡ªå‹•åŒæ­¥ = è€å¸«æ•‘æ˜Ÿ</div>

  <!-- API è¨­å®šå€ -->
  <div class="card">
    <div class="card-header">ğŸ”‘ ç³»çµ±è¨­å®š (è‡ªå‹•å„²å­˜)</div>
    <div class="grid-2">
      <div>
        <label>Gemini API Key</label>
        <input type="password" id="geminiKey" placeholder="è²¼ä¸Š Gemini Key" />
      </div>
      <div>
        <label>GitHub Token (repo æ¬Šé™)</label>
        <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx" />
      </div>
    </div>
    <div class="grid-2">
      <div>
        <label>GitHub ç”¨æˆ¶å (Owner)</label>
        <input type="text" id="githubOwner" placeholder="ä¾‹å¦‚: emmett-chen" />
      </div>
      <div>
        <label>GitHub å€‰åº«å (Repo)</label>
        <input type="text" id="githubRepo" placeholder="ä¾‹å¦‚: gept-game" />
      </div>
    </div>
  </div>

  <!-- å‡ºé¡Œå€ -->
  <div class="card">
    <div class="card-header">ğŸ“ ç¬¬ä¸€æ­¥ï¼šè¼¸å…¥å–®å­—</div>
    <label>è¼¸å…¥å–®å­—åˆ—è¡¨ (ä¸€è¡Œä¸€å€‹)</label>
    <textarea id="wordList" placeholder="apple&#10;banana&#10;computer"></textarea>

    <button id="generateBtn" class="btn" onclick="generateContent()">
      âœ¨ AI è‡ªå‹•ç”Ÿæˆé¡Œç›®
    </button>
  </div>

  <div id="loading">
    <div class="spinner"></div> æ­£åœ¨å‘¼å« AI å¤§è…¦ï¼Œè«‹ç¨å€™...
  </div>

  <!-- çµæœèˆ‡ä¸Šå‚³å€ -->
  <div id="resultArea" class="card" style="display:none;">
    <div class="card-header">
      <span>ğŸš€ ç¬¬äºŒæ­¥ï¼šé è¦½èˆ‡ç™¼å¸ƒ</span>
      <button class="btn btn-github" style="width:auto; padding: 6px 16px; font-size:0.9em;" onclick="downloadJSON()">
        ğŸ“¥ åƒ…ä¸‹è¼‰ JSON
      </button>
    </div>

    <div style="margin-bottom: 20px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
        <label style="color:var(--success);">æº–å‚™ä¸Šå‚³åˆ° GitHub:</label>
        <div style="display:flex; gap:10px;">
            <input type="text" id="targetFilename" placeholder="æª”å (ä¾‹å¦‚: week3.json)" style="margin-bottom:0;" />
            <button id="uploadBtn" class="btn btn-github" style="width: 180px;" onclick="uploadToGitHub()">
                â˜ï¸ ä¸Šå‚³ç™¼å¸ƒ
            </button>
        </div>
        <div id="uploadStatus" class="status-msg"></div>
    </div>

    <div id="previewContainer"></div>
  </div>
</div>

<script>
  let generatedData = [];

  // åˆå§‹åŒ–ï¼šè®€å– LocalStorage
  const fields = ['geminiKey', 'githubToken', 'githubOwner', 'githubRepo'];
  fields.forEach(id => {
    const saved = localStorage.getItem(id);
    if (saved) document.getElementById(id).value = saved;
    // ç¶å®šè‡ªå‹•å„²å­˜
    document.getElementById(id).addEventListener('change', (e) => {
      localStorage.setItem(id, e.target.value.trim());
    });
  });

  async function generateContent() {
    const apiKey = document.getElementById('geminiKey').value.trim();
    const words = document.getElementById('wordList').value.trim();

    if (!apiKey) { alert("è«‹è¼¸å…¥ Gemini API Keyï¼"); return; }
    if (!words) { alert("è«‹è¼¸å…¥å–®å­—ï¼"); return; }

    document.getElementById('generateBtn').disabled = true;
    document.getElementById('loading').style.display = 'block';
    document.getElementById('resultArea').style.display = 'none';

    const wordList = words.split('\n').filter(w => w.trim() !== '').join(', ');

    const prompt = `
      Act as an expert English teacher for GEPT Elementary (å…¨æ°‘è‹±æª¢åˆç´š) in Taiwan.
      Generate a JSON array for these words: ${wordList}.
      
      Each object must have:
      1. "Vocabulary": The word.
      2. "Chinese": Traditional Chinese definition (short).
      3. "sentence": A simple A2 level sentence, replace target word with "________".
      4. "answer": The target word.
      5. "distractors": Array of 3 wrong words (same part of speech).
      6. "chinese_sentence": Traditional Chinese translation of the sentence.

      Output ONLY valid JSON. No markdown.
    `;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });

      const data = await response.json();
      if (data.error) throw new Error(data.error.message);

      let rawText = data.candidates[0].content.parts[0].text;
      rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
      
      generatedData = JSON.parse(rawText);
      
      // è‡ªå‹•ç”¢ç”Ÿé è¨­æª”å
      const now = new Date();
      const dateStr = `${now.getMonth()+1}${now.getDate()}`;
      document.getElementById('targetFilename').value = `quiz_${dateStr}.json`;

      renderPreview();
      document.getElementById('resultArea').style.display = 'block';

    } catch (error) {
      alert("ç”Ÿæˆå¤±æ•—ï¼š" + error.message);
    } finally {
      document.getElementById('generateBtn').disabled = false;
      document.getElementById('loading').style.display = 'none';
    }
  }

  function renderPreview() {
    const container = document.getElementById('previewContainer');
    container.innerHTML = '';

    generatedData.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'preview-item';
      div.innerHTML = `
        <div style="font-weight:bold; color:var(--accent); text-align:center;">${index + 1}</div>
        <div style="width: 100%;">
          <input class="preview-input" style="font-weight:bold; color:#fff;" value="${item.Vocabulary}" onchange="updateData(${index}, 'Vocabulary', this.value)">
          <input class="preview-input" value="${item.Chinese}" onchange="updateData(${index}, 'Chinese', this.value)">
          <input class="preview-input" value="${item.sentence}" onchange="updateData(${index}, 'sentence', this.value)">
          <input class="preview-input" value="${item.chinese_sentence}" onchange="updateData(${index}, 'chinese_sentence', this.value)">
          <input class="preview-input" style="font-size:0.8em; color:#94a3b8;" value="${item.distractors.join(', ')}" onchange="updateDistractors(${index}, this.value)">
        </div>
      `;
      container.appendChild(div);
    });
  }

  function updateData(index, field, value) { generatedData[index][field] = value; }
  function updateDistractors(index, value) { generatedData[index].distractors = value.split(',').map(s => s.trim()); }

  // --- GitHub ä¸Šå‚³é‚è¼¯ ---
  async function uploadToGitHub() {
    const token = document.getElementById('githubToken').value.trim();
    const owner = document.getElementById('githubOwner').value.trim();
    const repo = document.getElementById('githubRepo').value.trim();
    const filename = document.getElementById('targetFilename').value.trim();
    const statusDiv = document.getElementById('uploadStatus');
    const btn = document.getElementById('uploadBtn');

    if (!token || !owner || !repo || !filename) {
      alert("è«‹å¡«å¯«å®Œæ•´çš„ GitHub è¨­å®š (Token, ç”¨æˆ¶å, å€‰åº«å, æª”å)ï¼");
      return;
    }

    btn.disabled = true;
    btn.innerHTML = "â³ ä¸Šå‚³ä¸­...";
    statusDiv.style.display = 'none';

    // æº–å‚™è³‡æ–™ï¼šåŒæ­¥ Vocabulary å’Œ Answer
    const finalData = generatedData.map(item => ({
      ...item,
      answer: item.Vocabulary // ç¢ºä¿ answer æ­£ç¢º
    }));

    const content = JSON.stringify(finalData, null, 2);
    // è§£æ±ºä¸­æ–‡ç·¨ç¢¼å•é¡Œï¼šå…ˆ encodeURI å† btoa
    const base64Content = btoa(unescape(encodeURIComponent(content)));
    const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${filename}`;

    try {
      // 1. å…ˆæª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨ (ç‚ºäº†å–å¾— sha)
      let sha = null;
      const checkRes = await fetch(apiUrl, {
        headers: { 
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
        }
      });

      if (checkRes.ok) {
        const fileData = await checkRes.json();
        sha = fileData.sha;
        if (!confirm(`æª”æ¡ˆ ${filename} å·²å­˜åœ¨ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ`)) {
            throw new Error("å–æ¶ˆä¸Šå‚³");
        }
      }

      // 2. ç™¼é€ PUT è«‹æ±‚å»ºç«‹/æ›´æ–°æª”æ¡ˆ
      const putRes = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: `Upload via GEPT Admin: ${filename}`,
          content: base64Content,
          sha: sha // å¦‚æœæ˜¯æ›´æ–°ï¼Œå¿…é ˆå¸¶ä¸Š sha
        })
      });

      if (!putRes.ok) {
        const err = await putRes.json();
        throw new Error(err.message);
      }

      statusDiv.className = 'status-msg status-success';
      statusDiv.innerHTML = `âœ… æˆåŠŸä¸Šå‚³ï¼<br>æª”æ¡ˆä½ç½®ï¼š<a href="https://github.com/${owner}/${repo}/blob/main/${filename}" target="_blank" style="color:inherit;">${filename}</a><br>è«‹è¨˜å¾—å»éŠæˆ²è¨­å®šæ–°å¢æ­¤é¡Œåº«ã€‚`;
      statusDiv.style.display = 'block';

    } catch (error) {
      if (error.message !== "å–æ¶ˆä¸Šå‚³") {
        statusDiv.className = 'status-msg status-error';
        statusDiv.innerText = `âŒ ä¸Šå‚³å¤±æ•—: ${error.message}`;
        statusDiv.style.display = 'block';
      }
    } finally {
      btn.disabled = false;
      btn.innerHTML = "â˜ï¸ ä¸Šå‚³ç™¼å¸ƒ";
    }
  }

  function downloadJSON() {
    // èˆ‡ä¸Šå‚³é‚è¼¯ç›¸åŒï¼Œæ•´ç†è³‡æ–™
    const finalData = generatedData.map(item => ({ ...item, answer: item.Vocabulary }));
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(finalData, null, 2));
    const link = document.createElement('a');
    link.href = dataStr;
    link.download = document.getElementById('targetFilename').value || "data.json";
    link.click();
  }
</script>

</body>
</html>
